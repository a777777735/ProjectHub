<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人力需求總表 (終極排程整合版)</title>

    <script src="./xlsx.full.min.js"></script>

    <style>
        /* ================= 全局與主表樣式 ================= */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        .control-panel {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 15px 20px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 12px;
        }

        .header-row h2 {
            margin: 0;
            color: #1565C0;
            font-size: 22px;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .header-row h2 span {
            font-size: 14px;
            color: #78909c;
            font-weight: normal;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tools-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .filter-controls,
        .view-controls {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 13px;
            flex-wrap: wrap;
            flex: 1;
        }

        .panel-label {
            font-weight: bold;
            color: #455a64;
            white-space: nowrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            outline: none;
            background: #fff;
        }

        .filter-controls input {
            flex: 1;
            min-width: 120px;
        }

        .view-controls {
            flex: 1.2;
        }

        .view-controls label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #0277bd;
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            transition: 0.2s;
            user-select: none;
        }

        .view-controls label:hover {
            background: #bbdefb;
        }

        .view-controls input[type="checkbox"] {
            cursor: pointer;
            margin: 0;
        }

        button {
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            transition: 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
            font-weight: bold;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-main {
            background-color: #43a047;
            font-size: 14px;
            padding: 8px 18px;
        }

        .btn-matrix {
            background-color: #1565C0;
            font-size: 14px;
            padding: 8px 18px;
        }

        .btn-danger {
            background-color: #e53935;
        }

        .btn-setting {
            background-color: #546e7a;
        }

        .btn-export {
            background-color: #1e88e5;
        }

        .btn-import {
            background-color: #fb8c00;
        }

        .btn-recovery {
            background-color: #8e24aa;
        }

        .btn-copy {
            background-color: #00897b;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            font-weight: normal;
            background-color: #9e9e9e;
        }

        .btn-cancel {
            background-color: #777;
        }

        .context-menu {
            position: absolute;
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 6px 0;
            min-width: 160px;
            z-index: 2000;
            font-size: 14px;
            border: 1px solid #eee;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f0f8ff;
            color: #1976D2;
        }

        .context-menu-item.danger:hover {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .context-menu-item.disabled {
            color: #aaa;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background-color: white;
            color: #aaa;
        }

        .inline-workload-input {
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            border: 1px solid transparent;
            border-radius: 2px;
            font-size: 12px;
            padding: 2px 0;
            background-color: transparent;
            transition: 0.2s;
        }

        .inline-workload-input:hover {
            border-color: #ccc;
            background-color: #fcfcfc;
        }

        .inline-workload-input:focus {
            outline: none;
            border-color: #2196f3;
            background-color: #fff;
            box-shadow: 0 0 3px rgba(33, 150, 243, 0.5);
        }

        .inline-workload-input:invalid {
            border-color: red;
            background-color: #ffebee;
        }

        /* 💡 修正：強制隱藏數字輸入框的上下箭頭，只有滑鼠停留在上面時才顯示 */

        /* 針對 Chrome, Safari, Edge */
        .inline-workload-input::-webkit-inner-spin-button,
        .inline-workload-input::-webkit-outer-spin-button {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .inline-workload-input:hover::-webkit-inner-spin-button,
        .inline-workload-input:hover::-webkit-outer-spin-button {
            opacity: 1;
        }

        /* 針對 Firefox */
        .inline-workload-input {
            -moz-appearance: textfield;
        }

        .inline-workload-input:hover {
            -moz-appearance: number-input;
        }

        .inline-select {
            width: 100%;
            min-width: max-content;
            box-sizing: border-box;
            border: 1px solid transparent;
            background: transparent;
            font-size: 13px;
            padding: 2px 16px 2px 8px;
            text-align: center;
            text-align-last: center;
            border-radius: 2px;
            cursor: pointer;
            color: #0277bd;
            font-weight: bold;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none;
            transition: all 0.2s ease;
        }

        .inline-select:hover,
        .inline-select:focus {
            border-color: #ccc;
            background-color: #fafafa;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%230277bd" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 2px center;
        }

        .inline-select:focus {
            border-color: #2196f3;
            background-color: #fff;
            outline: none;
            box-shadow: 0 0 3px rgba(33, 150, 243, 0.3);
        }

        :root {
            --col-width: 45.5px;
        }

        .table-container {
            overflow: auto;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            flex: 1;
            min-height: 0;
            transition: cursor 0.2s;
        }

        .table-container.is-panning {
            cursor: grabbing !important;
            user-select: none;
        }

        .time-col {
            min-width: var(--col-width) !important;
            max-width: var(--col-width) !important;
            width: var(--col-width) !important;
            transition: min-width 0.1s ease-out, max-width 0.1s ease-out, width 0.1s ease-out;
            overflow: visible;
            position: relative;
            vertical-align: bottom;
            padding: 4px 0 !important;
        }

        .col-region,
        .col-project,
        .col-category,
        .col-macro,
        .col-micro,
        .col-task,
        .col-subtask,
        .col-group,
        .col-name {
            width: 1%;
            min-width: max-content !important;
            padding-left: 1.5px !important;
            padding-right: 1.5px !important;
            white-space: nowrap;
        }

        .phase-bar {
            position: absolute;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            text-align: left;
            line-height: 18px;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.5), 0 1px 2px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: clip;
            z-index: 5;
            box-sizing: border-box;
            padding-left: 6px;
            cursor: pointer;
            transition: filter 0.2s;
        }

        .phase-bar:hover {
            filter: brightness(0.85);
            z-index: 15 !important;
        }

        table {
            width: max-content;
            border-collapse: separate;
            border-spacing: 0;
            white-space: nowrap;
            border-top: 1px solid #ddd;
            border-left: 1px solid #ddd;
            table-layout: fixed;
        }

        th,
        td {
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
            padding: 2px 4px;
            text-align: center;
            font-size: 12px;
            background-clip: padding-box;
        }

        tbody tr {
            background-color: #ffffff;
            cursor: context-menu;
        }

        tbody tr:hover {
            background-color: #f0f8ff;
        }

        #monthTheadTr th {
            position: sticky;
            top: 0;
            z-index: 20;
            height: 28px;
            box-sizing: border-box;
        }

        #monthTheadTr th[rowspan="2"] {
            z-index: 50;
            background-color: #e2e8f0;
        }

        #mainTheadTr th {
            position: sticky;
            top: 28px;
            z-index: 20;
            background-color: #f1f5f9;
            padding: 2px 0;
        }

        tfoot td {
            position: sticky;
            bottom: 0;
            z-index: 20;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            border-top: 2px solid #ffb300;
            background-color: #fff8e1;
            font-size: 12px;
        }

        th.sortable {
            cursor: grab;
            user-select: none;
            padding-right: 18px;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            filter: brightness(0.95);
        }

        th.sortable:active {
            cursor: grabbing;
        }

        th.sortable.drag-over {
            border-left: 3px solid #ff9800 !important;
            background-color: #ffe082 !important;
        }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.2;
            font-size: 12px;
        }

        th.sortable.asc::after {
            content: '🔼';
            opacity: 1;
        }

        th.sortable.desc::after {
            content: '🔽';
            opacity: 1;
        }

        .hidden-col {
            display: none !important;
        }

        .merged-cell {
            display: none !important;
        }

        td.highlight-target {
            outline: 3px solid #ff9800 !important;
            outline-offset: -3px;
            background-color: #fff3e0 !important;
            box-shadow: inset 0 0 10px rgba(255, 152, 0, 0.3) !important;
            z-index: 50 !important;
        }

        #cm-header {
            padding: 8px 16px;
            background: #e3f2fd;
            color: #0277bd;
            font-weight: bold;
            border-bottom: 1px solid #bbdefb;
            font-size: 13px;
            pointer-events: none;
        }

        /* ================= 系統原生彈出視窗 Modal ================= */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 20px 30px;
            border-radius: 8px;
            width: 98%;
            max-width: 1400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
            border-top: 2px solid #eee;
            padding-top: 15px;
        }

        /* ================= 新增/編輯視窗樣式 ================= */
        .relation-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            background: #fafafa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #eee;
            transition: all 0.3s;
        }

        .step-hidden {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(100%);
        }

        .check-group {
            flex: 1;
            min-width: 120px;
            display: flex;
            flex-direction: column;
        }

        .check-group label.title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #0056b3;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .check-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .check-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            color: #333;
        }

        .check-btn:hover {
            background: #e9ecef;
        }

        .check-btn.active {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #0d47a1;
            font-weight: bold;
            box-shadow: inset 3px 0 0 #2196f3;
        }

        .check-btn.disabled {
            display: none;
        }

        .tag-npi {
            background: #e1f5fe;
            color: #0277bd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .tag-mp {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .gantt-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
        }

        .gantt-scroll-area {
            min-width: 1200px;
            padding: 10px;
        }

        .gantt-container-parent {
            margin-left: 84px;
            width: calc(100% - 84px);
            margin-bottom: 8px;
            display: none;
        }

        .gantt-container {
            position: relative;
            width: 100%;
            height: 40px;
            background: #fdfdfd;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: height 0.3s;
        }

        .gantt-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            pointer-events: none;
        }

        .gantt-grid div {
            border-right: 1px dashed #e0e0e0;
            box-sizing: border-box;
        }

        .gantt-grid div:last-child {
            border-right: none;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 6px;
            font-size: 11px;
            color: white;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            overflow: hidden;
            transition: 0.3s;
        }

        .gantt-bar b {
            font-size: 12px;
            letter-spacing: 0.5px;
            margin: 0 4px;
        }

        .gantt-bar span {
            opacity: 0.9;
            font-size: 10px;
        }

        .workload-header-grid {
            display: grid;
            gap: 0;
            margin-bottom: 6px;
            align-items: end;
            width: max-content;
        }

        .workload-header {
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            background: #eee;
            border-radius: 0;
            padding: 4px 0;
            border-right: 1px solid #ccc;
        }

        .workload-rows-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: max-content;
        }

        .workload-row {
            display: grid;
            gap: 0;
            align-items: center;
            width: max-content;
        }

        .workload-row-name {
            font-weight: bold;
            text-align: center;
            background: #e3f2fd;
            padding: 6px 2px;
            border-radius: 4px;
            color: #0277bd;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 2px;
        }

        .workload-input-modal {
            width: 100%;
            text-align: center;
            border: 1px solid transparent;
            border-radius: 2px;
            font-size: 11px;
            padding: 2px 0;
            outline: none;
            transition: 0.2s;
        }

        .workload-input-modal:hover {
            border-color: #ccc;
        }

        .workload-input-modal:focus {
            border-color: #2196f3;
            box-shadow: 0 0 3px rgba(33, 150, 243, 0.5);
            background: #fff;
        }

        /* DB Modal */
        .db-tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-bottom: 15px;
            gap: 5px;
            flex-wrap: wrap;
        }

        .db-tab-btn {
            background: #f1f1f1;
            color: #333;
            border-radius: 6px 6px 0 0;
            padding: 10px 20px;
            font-weight: bold;
        }

        .db-tab-btn.active {
            background: #607d8b;
            color: white;
        }

        .db-tab-content {
            display: none;
        }

        .db-tab-content.active {
            display: block;
        }

        .action-bar {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .action-bar .action-label {
            font-weight: bold;
            display: flex;
            align-items: center;
            white-space: nowrap;
            font-size: 14px;
        }

        .action-bar input,
        .action-bar select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 1;
            min-width: 120px;
        }

        .db-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .db-table th,
        .db-table td {
            border: 1px solid #eee;
            padding: 8px 10px;
            text-align: left;
            font-size: 14px;
        }

        .db-table th {
            background-color: #f9f9f9;
            color: #555;
            position: sticky;
            top: 0;
        }

        /* ================= 🌟 資源分配矩陣專屬樣式 (am- prefix) ================= */
        #allocModal .modal-content {
            width: 98%;
            max-width: 1800px;
            height: 95vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .am-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .am-title {
            font-size: 22px;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .am-title span {
            font-size: 14px;
            font-weight: normal;
            color: #64748b;
        }

        .am-week-nav {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            overflow: hidden;
        }

        .am-btn-nav {
            background: transparent;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            color: #64748b;
            font-size: 15px;
            font-weight: bold;
            transition: 0.2s;
        }

        .am-btn-nav:hover {
            background: #e2e8f0;
            color: #3b82f6;
        }

        .am-week-sel-wrap {
            position: relative;
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        .am-week-sel {
            padding: 8px 30px 8px 16px;
            border: none;
            font-size: 15px;
            font-weight: 700;
            color: #3b82f6;
            background: transparent;
            outline: none;
            cursor: pointer;
            appearance: none;
            text-align: center;
        }

        .am-week-sel-wrap::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: #3b82f6;
            pointer-events: none;
        }

        .am-week-sel:hover {
            background: #eff6ff;
        }

        .am-main-layout {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .am-panel {
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .am-panel-left {
            flex: 1.4;
        }

        .am-panel-right {
            flex: 0.6;
        }

        .am-panel-title {
            background: #f8fafc;
            padding: 12px 20px;
            border-bottom: 1px solid #e2e8f0;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            flex-shrink: 0;
        }

        .am-content-scroll {
            overflow-y: auto;
            overflow-x: auto;
            flex: 1;
            padding: 15px;
        }

        .am-btn-add {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ffb74d;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .am-btn-add:hover {
            background: #ffe0b2;
            transform: translateY(-1px);
        }

        .am-matrix {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .am-matrix th {
            background: #f1f5f9;
            padding: 10px 6px;
            border-bottom: 2px solid #cbd5e1;
            border-right: 1px solid #e2e8f0;
            font-size: 13px;
            text-align: center;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .am-matrix th:last-child {
            border-right: none;
        }

        .am-matrix th.is-current {
            background: #e0e7ff;
            color: #1d4ed8;
            border-bottom: 2px solid #3b82f6;
        }

        .am-matrix td {
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px dashed #e2e8f0;
            vertical-align: top;
        }

        .am-matrix td:last-child {
            border-right: none;
        }

        .am-matrix td.is-current {
            background: #eff6ff;
            box-shadow: inset 0 0 0 1px #bfdbfe;
        }

        .am-matrix tr:last-child td {
            border-bottom: none;
        }

        .am-group-row td {
            background: #f8fafc;
            padding: 10px 16px;
            border-top: 2px solid #cbd5e1;
            border-bottom: 1px solid #cbd5e1;
            border-right: none;
        }

        .am-timeline-wrap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .am-task-info-td {
            min-width: 220px;
            max-width: 260px;
        }

        .am-task-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .am-task-path {
            font-size: 11px;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .am-badge-phase {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            border: 1px dashed #93c5fd;
        }

        .am-phase-prep {
            background: #fef08a;
            color: #9a3412;
            border-color: #fde047;
        }

        .am-phase-active {
            background: #e0e7ff;
            color: #1e40af;
        }

        .am-phase-post {
            background: #e5e7eb;
            color: #475569;
            border-color: #d1d5db;
        }

        .am-input-req {
            width: 35px;
            border: 1px dashed #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-weight: 700;
            color: #3b82f6;
            outline: none;
            background: transparent;
            font-size: 12px;
            transition: 0.2s;
            -moz-appearance: textfield;
            padding: 2px 0;
        }

        .am-input-req::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .am-input-req:hover,
        .am-input-req:focus {
            background: #fff;
            border-style: solid;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #eff6ff;
            cursor: text;
        }

        .am-assign-controls {
            background: #fff;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .am-assign-sel {
            padding: 4px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            outline: none;
            font-size: 12px;
            color: #334155;
            width: 100%;
            margin-bottom: 4px;
        }

        .am-assign-val {
            padding: 4px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            outline: none;
            font-size: 12px;
            width: 50%;
            box-sizing: border-box;
        }

        .am-btn-assign {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            width: 50%;
            box-sizing: border-box;
            transition: 0.2s;
        }

        .am-btn-assign:hover {
            background: #2563eb;
        }

        .am-pill {
            background: #dcfce7;
            color: #065f46;
            border-radius: 4px;
            padding: 3px 6px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 600;
            gap: 4px;
            border: 1px solid #a7f3d0;
        }

        .am-missing {
            color: #dc2626;
            font-weight: bold;
            font-size: 11px;
            background: #fee2e2;
            border-radius: 4px;
            padding: 3px 6px;
            display: block;
            text-align: center;
            border: 1px solid #fecaca;
            margin-bottom: 4px;
        }

        .am-btn-rm {
            background: transparent;
            border: none;
            color: #047857;
            cursor: pointer;
            padding: 0;
            font-size: 10px;
            line-height: 1;
            transition: 0.2s;
        }

        .am-pill:hover .am-btn-rm {
            color: #ef4444;
            transform: scale(1.2);
        }

        .am-group-hdr {
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 4px;
            margin: 20px 0 10px 0;
        }

        .am-person {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: 0.2s;
            margin-bottom: 6px;
            background: #fafafa;
        }

        .am-person:hover {
            background: #fff;
            border-color: #cbd5e1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .am-person-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .am-person-name {
            width: 65px;
            font-weight: 600;
            font-size: 14px;
            text-align: right;
            color: #334155;
        }

        .am-track {
            flex: 1;
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .am-fill {
            height: 100%;
            transition: width 0.4s, background-color 0.4s;
            border-radius: 4px;
        }

        .am-val {
            width: 35px;
            font-weight: 700;
            font-size: 13px;
            text-align: right;
        }

        .am-tasks {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding-left: 77px;
        }

        .am-task-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: #fff;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
            cursor: default;
        }

        .am-task-tag:hover {
            border-color: #fca5a5;
            background: #fee2e2;
            color: #b91c1c;
        }

        .am-tag-rm {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-size: 13px;
            display: none;
            line-height: 1;
        }

        .am-task-tag:hover .am-tag-rm {
            display: inline-block;
        }
    </style>
</head>

<body>

    <div class="control-panel">
        <div class="header-row">
            <h2>人力需求總表 <span>(全功能整合版)</span></h2>
            <div class="toolbar">
                <button class="btn-main" onclick="openDataModal(-1)">➕ 新增專案/任務</button>
                <button class="btn-matrix" onclick="openAllocModal()">📊 資源分配矩陣</button>
                <button class="btn-setting" onclick="openDbModal()">⚙️ 管理資料庫</button>
                <button class="btn-copy" onclick="copyTableToClipboard()">📋 複製視角</button>
                <button class="btn-export" onclick="exportToExcel()">📤 匯出</button>
                <button class="btn-import" onclick="document.getElementById('excelFileInput').click()">📥 匯入</button>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display: none;"
                    onchange="importFromExcel(event)">
                <button class="btn-recovery" onclick="openRecoveryModal()">🕒 救援</button>
                <button class="btn-danger" onclick="clearAllData()">🗑️ 清除</button>
            </div>
        </div>

        <div class="tools-row">
            <div class="filter-controls">
                <span class="panel-label">📅 區間：</span>
                <span id="timeline_range_label"
                    style="font-weight:bold; color:#e65100; font-size:14px; margin-right:10px; background:#fff3e0; padding:4px 8px; border-radius:4px;">自動推算中...</span>

                <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
                <span class="panel-label">🔍 篩選：</span>
                <select id="flt_region" onchange="applyMainFilter()">
                    <option value="">全部地區</option>
                </select>
                <select id="flt_project" onchange="applyMainFilter()">
                    <option value="">全部專案</option>
                </select>
                <select id="flt_category" onchange="applyMainFilter()">
                    <option value="">全部類別</option>
                </select>
                <select id="flt_macro" onchange="applyMainFilter()">
                    <option value="">大製程</option>
                </select>
                <select id="flt_group" onchange="applyMainFilter()">
                    <option value="">組別</option>
                </select>
                <input type="text" id="flt_keyword" placeholder="搜尋姓名/事項/小製程..." oninput="applyMainFilter()">
                <button class="btn-small" onclick="clearMainFilter()">清除</button>
            </div>

            <div class="view-controls">
                <span class="panel-label" title="💡 提示：按住 Ctrl + 滾輪可以無縫縮放右側時間軸，左側保持貼合！">👁️ 顯示：</span>
                <label><input type="checkbox" id="toggleRegion" checked onchange="applyColumnToggle()"> 地區</label>
                <label><input type="checkbox" id="toggleProject" checked onchange="applyColumnToggle()"> 專案</label>
                <label><input type="checkbox" id="toggleCategory" checked onchange="applyColumnToggle()"> 類別</label>
                <label><input type="checkbox" id="toggleMacro" checked onchange="applyColumnToggle()"> 大製程</label>
                <label><input type="checkbox" id="toggleMicro" checked onchange="applyColumnToggle()"> 小製程</label>
                <label><input type="checkbox" id="toggleTask" checked onchange="applyColumnToggle()"> 主事項</label>
                <label><input type="checkbox" id="toggleSubTask" checked onchange="applyColumnToggle()"> 小事項</label>
                <label><input type="checkbox" id="toggleGroup" checked onchange="applyColumnToggle()"> 組別</label>
                <label><input type="checkbox" id="toggleName" checked onchange="applyColumnToggle()"> 姓名</label>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="customContextMenu" class="context-menu" style="display: none;">
        <div id="cm-header"></div>
        <div id="cm-edit" class="context-menu-item" onclick="cmAction('edit')">✏️ 進階編輯資料</div>
        <div id="cm-duplicate" class="context-menu-item" onclick="cmAction('duplicate')">📄 複製此列向下</div>
        <div id="cm-delete" class="context-menu-item danger" onclick="cmAction('delete')">🗑️ 刪除此筆資料</div>
    </div>

    <div id="recoveryModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h3>🕒 歷史資料與設定救援</h3>
                <span class="close" onclick="closeModal('recoveryModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color:#555; font-size:14px; margin-bottom: 15px;">系統已掃描您在此電腦上所有曾經輸入過的版本。</p>
                <div style="max-height: 400px; overflow-y:auto;">
                    <table class="db-table" id="recoveryTable">
                        <thead>
                            <tr>
                                <th>版本名稱 (內部 Key)</th>
                                <th>總表資料筆數</th>
                                <th style="width: 180px;">操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">新增/編輯資料 <span
                        style="font-size:14px;color:#f57f17;font-weight:normal;margin-left:10px;">(你現在可以直接留空姓名，存檔後再從主頁指派！)</span>
                </h3>
                <span class="close" onclick="closeModal('dataModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIndex" value="-1">

                <div class="relation-container" style="background-color: #fff8e1; border-color: #ffe082;">
                    <div class="check-group"><label class="title" style="color:#f57f17;">1. 選擇地區 <span>📌
                                必選</span></label>
                        <div id="cl_region" class="check-list"></div>
                    </div>
                    <div class="check-group" id="block_project" style="display: none;"><label class="title"
                            style="color:#f57f17;">2. 選擇專案 <span>📌 必選</span></label>
                        <div id="cl_project" class="check-list"></div>
                    </div>
                    <div class="check-group" id="block_category" style="display: none;"><label class="title"
                            style="color:#f57f17;">3. 選擇類別 <span>📌 必選</span></label>
                        <div id="cl_category" class="check-list"></div>
                    </div>
                </div>

                <div id="block_details" class="step-hidden">
                    <div class="relation-container" style="background-color: #e0f2f1; border-color: #80cbc4;">
                        <div class="check-group"><label class="title" style="color:#00695c;">選擇大製程</label>
                            <div id="cl_macro" class="check-list"></div>
                        </div>
                        <div class="check-group"><label class="title" style="color:#00695c;">選擇小製程 <span
                                    style="font-size:12px; color:#c62828; font-weight:bold; margin-left:8px;">※
                                    勾選多個時，會自動分拆</span></label>
                            <div id="cl_micro" class="check-list"
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;"></div>
                        </div>
                    </div>

                    <div class="relation-container" style="background-color: #e8f5e9; border-color: #a5d6a7;">
                        <div class="check-group"><label class="title" style="color:#2e7d32;">選擇主事項</label>
                            <div id="cl_task" class="check-list"
                                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;"></div>
                        </div>
                        <div class="check-group"><label class="title" style="color:#2e7d32;">選擇綁定的小事項</label>
                            <div id="cl_subTask" class="check-list"
                                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;"></div>
                        </div>
                    </div>

                    <div style="text-align: center; margin: 15px 0;">
                        <button type="button" id="btn_toggle_advanced" onclick="toggleAdvancedScheduling()"
                            style="background-color: #f8fafc; color: #475569; border: 1px dashed #cbd5e1; width: 100%; padding: 10px; font-weight: bold; font-size: 14px; cursor: pointer; border-radius: 6px; transition: 0.2s;">
                            🔽 展開進階排程 (長期批次指派人員與週權重)
                        </button>
                    </div>

                    <div id="advanced_scheduling_block"
                        style="display: none; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #fafaf9; margin-bottom: 15px;">
                        <div class="relation-container" style="background-color: #f0f8ff; margin-bottom: 0;">
                            <div class="check-group"><label class="title">選擇組別</label>
                                <div id="cl_group" class="check-list"></div>
                            </div>
                            <div class="check-group" style="flex:2;"><label class="title">選擇姓名</label>
                                <div id="cl_name" class="check-list"
                                    style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;"></div>
                            </div>
                        </div>

                        <hr style="border-top: 1px dashed #ccc; margin: 15px 0;">
                        <label
                            style="font-weight:bold; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center; color:#00695c;">
                            <span>建立專案人力分配 (W週權重)</span>
                            <div id="unassigned_count_container"
                                style="display:none; background:#fff3e0; padding:4px 10px; border-radius:6px; border:1px solid #ffb300; align-items:center; gap:8px;">
                                <span style="font-size:13px; color:#e65100; font-weight:bold;">未指派姓名，預留名額數：</span>
                                <input type="number" id="unassignedCount" value="1" min="1" max="50"
                                    style="width:50px; text-align:center; border:1px solid #ffb300; border-radius:4px; padding:2px; outline:none;">
                            </div>
                        </label>

                        <div class="gantt-wrapper" style="margin-bottom: 0;">
                            <div class="gantt-scroll-area">
                                <div id="gantt_container_parent" class="gantt-container-parent">
                                    <div class="gantt-container" id="gantt_container">
                                        <div class="gantt-grid" id="gantt_grid"></div>
                                        <div id="gantt_bars"
                                            style="width: 100%; height: 100%; position: absolute; top:0; left:0; overflow:hidden;">
                                        </div>
                                    </div>
                                </div>
                                <div class="workload-header-grid" id="modal_workload_headers"></div>
                                <div id="workload_rows" class="workload-rows-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('dataModal')">取消</button>
                <button id="btn_save_data" onclick="saveDataRow()">💾 確認儲存至總表</button>
            </div>
        </div>
    </div>

    <div id="dbModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ 管理關聯資料庫</h3>
                <span class="close" onclick="closeModal('dbModal')">&times;</span>
            </div>
            <datalist id="dl_groups"></datalist><datalist id="dl_names"></datalist>
            <datalist id="dl_regions"></datalist><datalist id="dl_projects"></datalist>
            <datalist id="dl_macros"></datalist><datalist id="dl_micros"></datalist>
            <datalist id="dl_tasks"></datalist>
            <div class="db-tabs">
                <button class="db-tab-btn active" onclick="switchDbTab('rp')">1. 地區 ↔ 專案</button>
                <button class="db-tab-btn" onclick="switchDbTab('milestone')">2. 階段時程</button>
                <button class="db-tab-btn" style="background:#e0f2f1; color:#00695c;"
                    onclick="switchDbTab('process')">3. 大小製程</button>
                <button class="db-tab-btn" onclick="switchDbTab('group')">4. 組別 ➔ 姓名</button>
                <button class="db-tab-btn" style="background:#e8f5e9; color:#2e7d32;" onclick="switchDbTab('task')">5.
                    事項綁定</button>
            </div>

            <div id="tab_rp" class="db-tab-content active">
                <div class="action-bar" style="background: #fff8e1; border-color: #ffe082;">
                    <input type="text" list="dl_regions" id="rp_region" placeholder="輸入地區...">
                    <input type="text" list="dl_projects" id="rp_project" placeholder="輸入專案...">
                    <button onclick="addDbRpLink()" style="background:#ff9800;">新增</button>
                </div>
                <table class="db-table">
                    <tbody id="db_rp_list"></tbody>
                </table>
            </div>
            <div id="tab_milestone" class="db-tab-content">
                <div class="action-bar" style="background: #e1f5fe; border: 1px solid #81d4fa;">
                    <select id="ms_rp" style="flex: 2;">
                        <option value="">-- 地區/專案 --</option>
                    </select>
                    <select id="ms_category" style="max-width: 100px;">
                        <option value="NPI">NPI</option>
                        <option value="Ops.">Ops.</option>
                    </select>
                    <input type="text" id="ms_phase" placeholder="階段(如P2)" style="max-width: 110px;">
                    <input type="date" id="ms_start"> ~ <input type="date" id="ms_end">
                    <button onclick="addDbMilestone()" style="background:#0288d1;">新增</button>
                </div>
                <table class="db-table">
                    <tbody id="db_milestone_list"></tbody>
                </table>
            </div>
            <div id="tab_process" class="db-tab-content">
                <div class="action-bar" style="background: #e0f2f1; border-color: #b2dfdb;">
                    <input type="text" list="dl_macros" id="proc_macro" placeholder="大製程...">
                    <input type="text" list="dl_micros" id="proc_micro" placeholder="小製程...">
                    <button onclick="addDbProcessLink()" style="background:#00897b;">新增</button>
                </div>
                <table class="db-table">
                    <tbody id="db_process_list"></tbody>
                </table>
            </div>
            <div id="tab_group" class="db-tab-content">
                <div class="action-bar" style="background: #fce4ec; border-color: #f8bbd0;">
                    <input type="text" list="dl_groups" id="grp_group" placeholder="組別...">
                    <input type="text" list="dl_names" id="grp_name" placeholder="姓名...">
                    <button onclick="addDbGroupLink()" style="background:#e91e63;">新增</button>
                </div>
                <table class="db-table">
                    <tbody id="db_group_list"></tbody>
                </table>
            </div>
            <div id="tab_task" class="db-tab-content">
                <div class="action-bar" style="background: #e8f5e9; border-color: #a5d6a7;">
                    <input type="text" list="dl_tasks" id="task_main" placeholder="主事項...">
                    <input type="text" id="task_sub" placeholder="小事項...">
                    <button onclick="addDbTaskLink()" style="background:#4CAF50;">新增</button>
                </div>
                <table class="db-table">
                    <tbody id="db_task_list"></tbody>
                </table>
            </div>
            <div class="modal-footer"><button onclick="closeModal('dbModal')">完成並關閉</button></div>
        </div>
    </div>

    <div id="editDbModal" class="modal" style="z-index: 1005;">
        <div class="modal-content" style="max-width: 400px; margin-top: 10%;">
            <div class="modal-header">
                <h3>✏️ 編輯</h3><span class="close" onclick="closeModal('editDbModal')">&times;</span>
            </div>
            <div class="modal-body" id="editDbBody"></div>
            <div class="modal-footer"><button onclick="saveDbEdit()" style="background:#ff9800;">💾 儲存並更新</button></div>
        </div>
    </div>

    <div id="allocModal" class="modal">
        <div class="modal-content alloc-modal-content">
            <div class="am-header">
                <h2 class="am-title">📊 專案資源分配矩陣 <span>(全局排程視角)</span></h2>
                <div class="am-week-nav">
                    <button class="am-btn-nav" onclick="changeAllocWeek(-1)">◀</button>
                    <div class="am-week-sel-wrap">
                        <select id="allocWeekSelector" class="am-week-sel" onchange="updateAllocView()"></select>
                    </div>
                    <button class="am-btn-nav" onclick="changeAllocWeek(1)">▶</button>
                </div>
                <span class="close" onclick="closeModal('allocModal')">&times;</span>
            </div>

            <div class="am-main-layout">
                <div class="am-panel am-panel-left">
                    <h3 class="am-panel-title">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span>📋 任務排程矩陣</span>
                            <span id="allocUnassignedCount" class="count-badge"
                                style="background:#ef4444; color:white; padding:2px 8px; border-radius:12px; font-size:12px;">0</span>
                        </div>
                    </h3>
                    <div class="am-content-scroll" id="allocEventList"></div>
                </div>

                <div class="am-panel am-panel-right">
                    <h3 class="am-panel-title" id="allocRightPanelTitle">👥 團隊負荷水位表</h3>
                    <div class="am-content-scroll" id="allocPersonnelList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="allocAddReqModal" class="modal" style="z-index: 1010;">
        <div class="modal-content" style="max-width: 400px; margin-top: 10%;">
            <div class="modal-header">
                <h3 style="margin:0; font-size:18px;">➕ 在本週引入預備任務</h3>
                <span class="close"
                    onclick="document.getElementById('allocAddReqModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <label
                    style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:4px;">關聯專案</label>
                <select id="allocNewReqProject"
                    style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:12px;"></select>

                <div style="display:flex; gap:10px; margin-bottom:12px;">
                    <div style="flex:1;">
                        <label
                            style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:4px;">大製程</label>
                        <input type="text" id="allocNewReqMacro" value="準備工作"
                            style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div style="flex:1;">
                        <label
                            style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:4px;">小製程</label>
                        <input type="text" id="allocNewReqMicro" value="資料蒐集"
                            style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                <label
                    style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:4px;">任務名稱</label>
                <input type="text" id="allocNewReqTask" value="階段前期規劃"
                    style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:12px; box-sizing:border-box;">

                <label
                    style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:4px;">本週需求人力</label>
                <input type="number" id="allocNewReqVal" value="1.0" min="0.1" step="0.1"
                    style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:15px; box-sizing:border-box;">
            </div>
            <div class="modal-footer">
                <button class="btn-main" style="width:100%;" onclick="submitAllocNewReq()">建立並加入排程</button>
            </div>
        </div>
    </div>


    <script>
        // ================= 核心設定 =================
        let mainTableData = [];
        let db = { rpLinks: [], milestones: [], processLinks: [], groupLinks: [], taskLinks: [] };
        let currentSelections = { group: "", name: [], region: "", project: "", category: "", macro: "", micro: [], task: "", subTask: [] };
        let currentWorkloads = {};
        let currentSort = { column: '', direction: 'asc' };
        let cmTargetContext = null;

        let defaultColOrder = ['region', 'project', 'category', 'macro', 'micro', 'task', 'subTask', 'group', 'name'];
        let colOrder = JSON.parse(localStorage.getItem('colOrderV36')) || defaultColOrder;

        // 🌟 核心：永遠保持週模式的格子，並使用精準天數計算月份的百分比寬度
        let pixelsPerDay = 6.5;
        let timelineCols = [];
        let timelineMonths = [];
        let timelineStartMs = 0;
        let timelineEndMs = 0;

        function getISOWeek(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function generateTimeline() {
            timelineCols = [];
            timelineMonths = [];

            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth() - 3, 1);
            const endMonth = new Date(now.getFullYear(), now.getMonth() + 12, 0);

            const labelEl = document.getElementById('timeline_range_label');
            if (labelEl) labelEl.innerText = `${startMonth.getFullYear()}年${startMonth.getMonth() + 1}月 ~ ${endMonth.getFullYear()}年${endMonth.getMonth() + 1}月`;

            let curr = new Date(startMonth);
            const startDay = curr.getDay() || 7;
            curr.setDate(curr.getDate() - startDay + 1);
            timelineStartMs = curr.setHours(0, 0, 0, 0);

            let weekCurr = new Date(timelineStartMs);
            let endLimit = endMonth.getTime();

            while (weekCurr.getTime() <= endLimit) {
                let thursday = new Date(weekCurr);
                thursday.setDate(thursday.getDate() + 3);
                let year = thursday.getFullYear();
                let weekNum = getISOWeek(thursday);

                let monday = new Date(weekCurr);
                let dateStr = `${monday.getMonth() + 1}/${monday.getDate()}`;
                let key = `y${year}_w${weekNum}`;

                let startMs = monday.getTime();
                let sunday = new Date(monday);
                sunday.setDate(sunday.getDate() + 6);
                let endMs = sunday.setHours(23, 59, 59, 999);

                timelineCols.push({ year, label: `W${weekNum}`, subLabel: dateStr, key: key, startMs, endMs });

                weekCurr.setDate(weekCurr.getDate() + 7);
                timelineEndMs = endMs;
            }

            let totalDays = Math.round((timelineEndMs - timelineStartMs + 1) / 86400000);
            let monthCurr = new Date(timelineStartMs);

            while (monthCurr.getTime() <= timelineEndMs) {
                let y = monthCurr.getFullYear();
                let m = monthCurr.getMonth();

                let startOfThisMonth = new Date(y, m, 1).getTime();
                let endOfThisMonth = new Date(y, m + 1, 0, 23, 59, 59, 999).getTime();

                let actualStart = Math.max(timelineStartMs, startOfThisMonth);
                let actualEnd = Math.min(timelineEndMs, endOfThisMonth);

                let daysSpanned = Math.round((actualEnd - actualStart + 1) / 86400000);

                if (daysSpanned > 0) {
                    timelineMonths.push({
                        label: `${y}年 ${m + 1}月`,
                        widthPct: (daysSpanned / totalDays) * 100
                    });
                }
                monthCurr = new Date(y, m + 1, 1);
            }
        }

        // ================= 初始化 =================
        document.addEventListener('DOMContentLoaded', () => {
            generateTimeline();
            loadAllStorage();
            initModalHeaders();
            renderMainTable();
            setupContextMenu();
            setupPanAndZoom();
        });

        // ================= 滑鼠左鍵左右平移與無縫縮放 =================
        function setupPanAndZoom() {
            const container = document.querySelector('.table-container');

            container.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const zoomFactor = 1.15;
                    if (e.deltaY < 0) pixelsPerDay *= zoomFactor;
                    else pixelsPerDay /= zoomFactor;

                    pixelsPerDay = Math.max(2, Math.min(100, pixelsPerDay));
                    const colWidth = pixelsPerDay * 7;
                    document.documentElement.style.setProperty('--col-width', `${colWidth}px`);
                    setTimeout(updateStickyColumns, 50);
                }
            }, { passive: false });

            let isPanning = false;
            let startX, scrollLeft;

            container.addEventListener('mousedown', (e) => {
                const isInteractive = ['INPUT', 'SELECT', 'BUTTON'].includes(e.target.tagName)
                    || e.target.closest('.phase-bar')
                    || e.target.closest('th[draggable="true"]');

                if (e.button === 0 && !isInteractive) {
                    if (e.target.tagName !== 'TH') e.preventDefault();
                    isPanning = true;
                    container.classList.add('is-panning');
                    startX = e.pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const walkX = (x - startX) * 1.5;
                container.scrollLeft = scrollLeft - walkX;
            });

            window.addEventListener('mouseup', (e) => {
                if (e.button === 0 && isPanning) {
                    isPanning = false;
                    container.classList.remove('is-panning');
                }
            });

            window.addEventListener('mouseleave', () => {
                if (isPanning) {
                    isPanning = false;
                    container.classList.remove('is-panning');
                }
            });
        }

        // ================= 資料載入與自動遷移 =================
        function loadAllStorage() {
            let savedData = localStorage.getItem('manpowerDataV36');
            let savedDb = localStorage.getItem('manpowerDbV36');

            if (!savedData) {
                let oldData = localStorage.getItem('manpowerDataV28');
                if (oldData) {
                    let parsedOld = JSON.parse(oldData);
                    let currentY = new Date().getFullYear();
                    mainTableData = parsedOld.map(row => {
                        let newRow = { ...row };
                        for (let m = 1; m <= 12; m++) {
                            if (row['m' + m]) {
                                let val = parseFloat(row['m' + m]) / 4;
                                let startW = (m - 1) * 4 + 1;
                                for (let w = startW; w <= startW + 3 && w <= 53; w++) {
                                    newRow[`y${currentY}_w${w}`] = Math.round(val * 100) / 100;
                                }
                                delete newRow['m' + m];
                            }
                        }
                        return newRow;
                    });
                }
            } else {
                mainTableData = JSON.parse(savedData);
            }

            if (savedDb) db = JSON.parse(savedDb);
            else { let oldDb = localStorage.getItem('manpowerDbV28'); if (oldDb) db = JSON.parse(oldDb); }

            if (!db.rpLinks) db.rpLinks = []; if (!db.milestones) db.milestones = [];
            if (!db.processLinks) db.processLinks = []; if (!db.groupLinks) db.groupLinks = [];
            if (!db.taskLinks) db.taskLinks = [];

            // 賦予舊資料 _id
            mainTableData.forEach(row => {
                if (!row._id) row._id = Date.now() + Math.floor(Math.random() * 1000000);
            });
            saveAllStorage();
        }

        function saveAllStorage() {
            localStorage.setItem('manpowerDataV36', JSON.stringify(mainTableData));
            localStorage.setItem('manpowerDbV36', JSON.stringify(db));
            updateFilterDropdowns();
        }

        // ================= 拖曳重組欄位功能 =================
        let draggedCol = null;
        window.dragStart = function (e) { draggedCol = e.target.getAttribute('data-col'); e.dataTransfer.effectAllowed = 'move'; setTimeout(() => e.target.style.opacity = '0.5', 0); };
        window.dragEnd = function (e) { e.target.style.opacity = '1'; document.querySelectorAll('th').forEach(th => th.classList.remove('drag-over')); };
        window.dragOver = function (e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; let target = e.target.closest('th'); if (target && target.getAttribute('draggable')) target.classList.add('drag-over'); };
        window.dragLeave = function (e) { let target = e.target.closest('th'); if (target) target.classList.remove('drag-over'); };
        window.dropCol = function (e) {
            e.preventDefault(); let target = e.target.closest('th'); if (!target) return;
            target.classList.remove('drag-over'); let targetCol = target.getAttribute('data-col');
            if (draggedCol && targetCol && draggedCol !== targetCol) {
                let fromIdx = colOrder.indexOf(draggedCol); let toIdx = colOrder.indexOf(targetCol);
                if (fromIdx > -1 && toIdx > -1) { colOrder.splice(fromIdx, 1); colOrder.splice(toIdx, 0, draggedCol); localStorage.setItem('colOrderV36', JSON.stringify(colOrder)); renderMainTable(); }
            }
        };

        function openRecoveryModal() {
            const tbody = document.querySelector('#recoveryTable tbody'); tbody.innerHTML = '';
            let foundAny = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('manpowerData')) {
                    const suffix = key.replace('manpowerData', '');
                    let versionDisplay = suffix === '' ? 'V1 (最早期)' : suffix;
                    const dbKey = 'manpowerDb' + suffix;
                    try {
                        const dataObj = JSON.parse(localStorage.getItem(key));
                        if (dataObj && Array.isArray(dataObj)) {
                            foundAny = true;
                            const isCurrent = (key === 'manpowerDataV36');
                            tbody.innerHTML += `<tr style="${isCurrent ? 'background-color:#f0f8ff;' : ''}">
                                    <td style="font-weight:bold; color:#0277bd;">${versionDisplay} ${isCurrent ? '<span style="font-size:10px;color:red;">(當前使用)</span>' : ''}</td>
                                    <td>${dataObj.length} 筆資料</td>
                                    <td><button class="btn-danger" style="padding: 4px 8px; font-size: 11px; margin-bottom: 2px;" onclick="recoverData('${key}', '${dbKey}')">完全覆蓋載入</button></td>
                                </tr>`;
                        }
                    } catch (e) { }
                }
            }
            if (!foundAny) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;">抱歉，未偵測到歷史紀錄。</td></tr>';
            document.getElementById('recoveryModal').style.display = 'block';
        }

        function recoverData(dataKey, dbKey) {
            try {
                if (!confirm(`警告！這將會用 [${dataKey}] 的資料完全取代目前的畫面。確定繼續嗎？`)) return;
                mainTableData = JSON.parse(localStorage.getItem(dataKey) || '[]'); db = JSON.parse(localStorage.getItem(dbKey) || '{}');
                saveAllStorage(); renderMainTable(); closeModal('recoveryModal');
            } catch (e) { alert('恢復資料時發生錯誤！'); }
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') { alert("找不到 Excel 引擎！"); return; }
            if (mainTableData.length === 0 && db.rpLinks.length === 0) { alert("目前沒有資料可以匯出喔！"); return; }

            const wb = XLSX.utils.book_new();
            const wsMain = XLSX.utils.json_to_sheet(mainTableData.map(row => {
                let exp = {
                    "地區": row.region || "", "專案": row.project || "", "類別": row.category || "",
                    "大製程": row.macro || "", "小製程": row.micro || "",
                    "組別": row.group || "", "姓名": row.name || "", "主事項": row.task || "", "小事項": row.subTask || ""
                };
                timelineCols.forEach(c => {
                    let colName = `${c.key.replace('y', '').replace('_w', '-W')}`;
                    exp[colName] = row[c.key] || "";
                });
                return exp;
            }));
            XLSX.utils.book_append_sheet(wb, wsMain, `動態專案總表`);
            XLSX.writeFile(wb, `人力需求總表_動態區間.xlsx`);
        }

        function importFromExcel(event) {
            const file = event.target.files[0]; if (!file) return;
            if (typeof XLSX === 'undefined') { alert("找不到 Excel 引擎！"); event.target.value = ""; return; }
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, { type: 'array' }); let newData = [];
                    if (wb.Sheets[wb.SheetNames[0]]) {
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                        newData = rows.map(r => {
                            let item = {
                                _id: Date.now() + Math.floor(Math.random() * 1000000),
                                region: String(r["地區"] || "").trim(), project: String(r["專案"] || "").trim(), category: String(r["類別"] || "").trim() === 'MP' ? 'Ops.' : String(r["類別"] || "").trim(),
                                macro: String(r["大製程"] || "").trim(), micro: String(r["小製程"] || "").trim(), group: String(r["組別"] || "").trim(), name: String(r["姓名"] || "").trim(), task: String(r["主事項"] || r["工作事項"] || "").trim(), subTask: String(r["小事項"] || "").trim()
                            };
                            Object.keys(r).forEach(k => {
                                const matchW = k.match(/(\d{4})-W(\d+)/);
                                if (matchW && String(r[k]).trim()) item[`y${matchW[1]}_w${matchW[2]}`] = String(r[k]).trim();
                            });
                            return item;
                        });
                    }
                    mainTableData = mainTableData.concat(newData);
                    saveAllStorage(); renderMainTable(); alert(`✅ Excel 匯入成功！`);
                } catch (error) { alert("讀取檔案發生錯誤。"); } finally { event.target.value = ""; }
            };
            reader.readAsArrayBuffer(file);
        }

        function copyTableToClipboard() {
            let tsvContent = ''; const table = document.getElementById('mainTable');
            for (let i = 0; i < table.rows.length; i++) {
                let row = table.rows[i]; let rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    let cell = row.cells[j];
                    if (window.getComputedStyle(cell).display !== 'none') {
                        let valSpan = cell.querySelector('.val-span');
                        let inputEl = cell.querySelector('input');
                        let selectEl = cell.querySelector('select');
                        let val = selectEl ? selectEl.value : (inputEl ? inputEl.value : (valSpan ? valSpan.textContent : cell.textContent.replace(/\n/g, ' ').trim()));
                        rowData.push(val);
                    }
                }
                tsvContent += rowData.join('\t') + '\n';
            }
            navigator.clipboard.writeText(tsvContent).then(() => alert('✅ 已複製，請至 Excel 貼上 (Ctrl+V)。'));
        }

        // ================= 篩選與排序 =================
        function updateMainFilterOptions() {
            if (!document.getElementById('flt_region')) return;
            const preserveValue = (id) => document.getElementById(id).value;
            const vals = { region: preserveValue('flt_region'), project: preserveValue('flt_project'), category: preserveValue('flt_category'), macro: preserveValue('flt_macro'), group: preserveValue('flt_group') };
            const setOptions = (id, field, defaultText) => {
                const el = document.getElementById(id); const uniqueVals = [...new Set(mainTableData.map(r => r[field]).filter(v => v))];
                el.innerHTML = `<option value="">${defaultText}</option>` + uniqueVals.map(v => `<option value="${v}">${v}</option>`).join('');
                el.value = vals[field] || "";
            };
            setOptions('flt_region', 'region', '全部地區'); setOptions('flt_project', 'project', '全部專案'); setOptions('flt_category', 'category', '全部類別'); setOptions('flt_macro', 'macro', '全部大製程'); setOptions('flt_group', 'group', '全部組別');
        }
        function applyMainFilter() { renderMainTable(); }
        function clearMainFilter() { document.getElementById('flt_region').value = ""; document.getElementById('flt_project').value = ""; document.getElementById('flt_category').value = ""; document.getElementById('flt_macro').value = ""; document.getElementById('flt_group').value = ""; document.getElementById('flt_keyword').value = ""; renderMainTable(); }
        function handleSort(column) { if (currentSort.column === column) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; else { currentSort.column = column; currentSort.direction = 'asc'; } renderMainTable(); }

        // ================= 右鍵選單 =================
        function setupContextMenu() {
            const menu = document.getElementById('customContextMenu'); const table = document.getElementById('mainTable');
            table.addEventListener('contextmenu', (e) => {
                const td = e.target.closest('td'); const tr = e.target.closest('tbody tr'); if (!td || !tr) { menu.style.display = 'none'; return; }
                e.preventDefault(); document.querySelectorAll('td.highlight-target').forEach(el => el.classList.remove('highlight-target')); td.classList.add('highlight-target');
                const editBtn = document.getElementById('cm-edit'); const dupBtn = document.getElementById('cm-duplicate'); const delBtn = document.getElementById('cm-delete'); const header = document.getElementById('cm-header');
                const indices = JSON.parse(td.dataset.mergedIndices || "[]");
                if (tr.dataset.type === 'readonly') {
                    header.innerText = '🔒 唯讀模式'; editBtn.innerHTML = '🔒 視角不可編輯'; dupBtn.innerHTML = '🔒 不可複製'; delBtn.innerHTML = '🔒 不可刪除';
                    editBtn.classList.add('disabled'); dupBtn.classList.add('disabled'); delBtn.classList.add('disabled'); cmTargetContext = { type: 'readonly' };
                } else if (indices.length > 1) {
                    header.innerText = `🎯 區塊操作 (${indices.length} 筆)`; editBtn.innerHTML = '✏️ 批次編輯此區塊資料'; dupBtn.innerHTML = '🔒 區塊不可複製'; delBtn.innerHTML = '🗑️ 刪除此區塊所有資料';
                    editBtn.classList.remove('disabled'); dupBtn.classList.add('disabled'); delBtn.classList.remove('disabled'); cmTargetContext = { type: 'group', indices: indices };
                } else {
                    header.innerText = `🎯 單筆資料操作`; editBtn.innerHTML = '✏️ 進階編輯此筆資料'; dupBtn.innerHTML = '📄 複製此列向下'; delBtn.innerHTML = '🗑️ 刪除此筆資料';
                    editBtn.classList.remove('disabled'); dupBtn.classList.remove('disabled'); delBtn.classList.remove('disabled'); cmTargetContext = { type: 'single', indices: indices };
                }
                menu.style.display = 'block'; let x = e.pageX; let y = e.pageY;
                if (x + menu.offsetWidth > window.innerWidth) x = window.innerWidth - menu.offsetWidth - 10; if (y + menu.offsetHeight > window.innerHeight) y = window.innerHeight - menu.offsetHeight - 10;
                menu.style.left = x + 'px'; menu.style.top = y + 'px';
            });
            document.addEventListener('click', (e) => { if (e.target.closest('#customContextMenu')) return; menu.style.display = 'none'; document.querySelectorAll('td.highlight-target').forEach(el => el.classList.remove('highlight-target')); });
        }
        function cmAction(action) {
            document.getElementById('customContextMenu').style.display = 'none'; document.querySelectorAll('td.highlight-target').forEach(el => el.classList.remove('highlight-target'));
            if (!cmTargetContext || cmTargetContext.type === 'readonly') return;
            if (cmTargetContext.type === 'single') { const idx = cmTargetContext.indices[0]; if (action === 'edit') openDataModal(idx); if (action === 'delete') deleteRow(idx); if (action === 'duplicate') duplicateRow(idx); }
            else if (cmTargetContext.type === 'group') { const indices = cmTargetContext.indices; if (action === 'edit') openGroupModal(indices); if (action === 'delete') deleteGroup(indices); }
        }
        function duplicateRow(index) {
            const newRow = { ...mainTableData[index] };
            newRow._id = Date.now() + Math.floor(Math.random() * 100000); // 確保複製時有新的獨立 ID
            mainTableData.splice(index + 1, 0, newRow);
            saveAllStorage(); renderMainTable();
        }
        function deleteRow(i) { if (confirm("確定刪除？")) { mainTableData.splice(i, 1); saveAllStorage(); renderMainTable(); } }
        function deleteGroup(indices) { if (confirm(`確定刪除 ${indices.length} 筆資料？`)) { indices.sort((a, b) => b - a).forEach(idx => { mainTableData.splice(idx, 1); }); saveAllStorage(); renderMainTable(); } }
        function clearAllData() { if (confirm("這將會清除總表上的所有資料，確定嗎？")) { mainTableData = []; saveAllStorage(); renderMainTable(); } }


        window.updateRowField = function (index, field, val) {
            if (mainTableData[index]) {
                mainTableData[index][field] = val;
                if (field === 'group') { const validNames = db.groupLinks.filter(l => l.group === val).map(l => l.name); if (val && !validNames.includes(mainTableData[index].name)) mainTableData[index].name = ""; }
                if (field === 'macro') { const validMicros = db.processLinks.filter(l => l.macro === val).map(l => l.micro); if (val && !validMicros.includes(mainTableData[index].micro)) mainTableData[index].micro = ""; }
                if (field === 'task') { const validSubs = db.taskLinks.filter(l => l.task === val).map(l => l.subTask); if (val && !validSubs.includes(mainTableData[index].subTask)) mainTableData[index].subTask = ""; }
                saveAllStorage(); renderMainTable();
            }
        };

        window.updateInlineWorkload = function (index, weekKey, val) {
            if (val && (val < 0.1 || val > 1)) { alert("權重分配請輸入 0.1 ~ 1 之間！"); renderMainTable(); return; }
            if (mainTableData[index]) { mainTableData[index][weekKey] = val; saveAllStorage(); updateFooterTotals(); }
        };

        window.updateFooterTotals = function () {
            let tempTotals = {};
            timelineCols.forEach(c => tempTotals[c.key] = 0);
            const rows = document.querySelectorAll('#mainTable tbody tr');
            rows.forEach(tr => {
                timelineCols.forEach((c, idx) => {
                    let cell = tr.cells[colOrder.length + idx];
                    if (cell) {
                        let input = cell.querySelector('input');
                        let valSpan = cell.querySelector('.val-span');
                        let val = 0;
                        if (input) val = parseFloat(input.value) || 0;
                        else if (valSpan) val = parseFloat(valSpan.textContent) || 0;
                        tempTotals[c.key] += val;
                    }
                });
            });
            timelineCols.forEach(c => {
                let fCell = document.getElementById('footer_' + c.key);
                if (fCell) { let sum = Math.round(tempTotals[c.key] * 100) / 100; fCell.innerText = sum > 0 ? sum : ""; }
            });
        };

        function applyColumnToggleDisplay(showFlags) {
            colOrder.forEach(col => {
                const className = '.col-' + col.toLowerCase(); const isShow = showFlags[col];
                document.querySelectorAll(className).forEach(el => { if (isShow) { el.classList.remove('hidden-col'); if (!el.classList.contains('merged-cell')) el.style.display = ''; } else { el.classList.add('hidden-col'); el.style.display = 'none'; } });
            });
            applyRowSpan(); updateStickyColumns();
        }

        function applyColumnToggle() { renderMainTable(); }

        function applyRowSpan() {
            const tbody = document.querySelector('#mainTable tbody'); const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(tr => {
                let baseIndices = tr.dataset.type === 'group' ? JSON.parse(tr.dataset.groupIndices) : [parseInt(tr.dataset.index)];
                Array.from(tr.cells).forEach(cell => { cell.rowSpan = 1; cell.classList.remove('merged-cell'); if (!cell.classList.contains('hidden-col')) cell.style.display = ''; cell.dataset.mergedIndices = JSON.stringify(baseIndices); });
            });
            const mergeCols = Array.from({ length: colOrder.length }, (_, i) => i);
            mergeCols.forEach(colIdx => {
                let prevCell = null; let rowspan = 1;
                for (let i = 0; i < rows.length; i++) {
                    const cell = rows[i].cells[colIdx]; if (!cell) continue;
                    let match = true;
                    if (i > 0 && prevCell) {
                        for (let c = 0; c <= colIdx; c++) {
                            const getVal = (td) => {
                                let s = td.querySelector('select');
                                let vs = td.querySelector('.val-span');
                                return s ? s.value : (vs ? vs.textContent.trim() : td.textContent.trim());
                            };
                            if (getVal(rows[i].cells[c]) !== getVal(rows[i - 1].cells[c])) { match = false; break; }
                        }
                    } else { match = false; }
                    if (match && prevCell && !cell.classList.contains('hidden-col')) {
                        rowspan++; prevCell.rowSpan = rowspan; cell.classList.add('merged-cell'); cell.style.display = 'none';
                        let prevIndices = JSON.parse(prevCell.dataset.mergedIndices); let currIndices = JSON.parse(cell.dataset.mergedIndices);
                        prevCell.dataset.mergedIndices = JSON.stringify([...new Set([...prevIndices, ...currIndices])]);
                    } else { if (!cell.classList.contains('hidden-col')) { prevCell = cell; rowspan = 1; } }
                }
            });
        }

        // ================= 🌟 主表模態框修復 (Add/Edit) =================
        function initModalHeaders() {
            let monthFlexHtml = `<div style="display: flex; width: 100%; height: 100%; border-radius: 4px; overflow: hidden; border: 1px solid #90caf9;">`;
            timelineMonths.forEach(m => {
                monthFlexHtml += `<div style="width: ${m.widthPct}%; border-right: 1px solid #90caf9; display: flex; align-items: center; justify-content: center; background-color: #e3f2fd; color: #0277bd; font-size: 11px; font-weight: bold; box-sizing: border-box; padding: 2px 0;">${m.label}</div>`;
            });
            monthFlexHtml += `</div>`;

            // 💡 設定月份從第二欄開始
            let monthHtml = `<div style="grid-column: 2 / span ${timelineCols.length}; grid-row: 1; padding: 0; margin-bottom: 2px;">${monthFlexHtml}</div>`;

            // 💡 修正：讓「人員」跨越兩行 (grid-row: 1 / span 2)，徹底封死左上角，防止文字滑過去時穿幫
            let weekHtml = `<div class="workload-header" style="grid-row: 1 / span 2; grid-column: 1; background:#f8fafc; justify-content:center; display:flex; align-items:center; border:none; border-right:2px solid #94a3b8; border-bottom:1px solid #cbd5e1; position:sticky; left:0; top:0; z-index:50; box-shadow: 3px 0 6px rgba(0,0,0,0.1); font-size: 13px; color: #334155;">人員</div>`;

            timelineCols.forEach((c, idx) => {
                let labelHtml = `${c.label}<br><span style="font-size: 9px; font-weight: normal; color: #78909c;">${c.subLabel}</span>`;
                // 💡 設定每一週的標題從第二行、第二欄開始排列
                weekHtml += `<div class="workload-header" style="grid-row: 2; grid-column: ${idx + 2}; cursor:pointer; line-height: 1.2;" title="清除 ${c.label} 分配" onclick="clearWeekWorkload('${c.key}')">${labelHtml}</div>`;
            });

            const headerGrid = document.getElementById('modal_workload_headers');
            headerGrid.style.gridTemplateColumns = `80px repeat(${timelineCols.length}, var(--col-width))`;
            headerGrid.innerHTML = monthHtml + weekHtml;

            const ganttGrid = document.getElementById('gantt_grid');
            ganttGrid.style.gridTemplateColumns = `repeat(${timelineCols.length}, 1fr)`;
            ganttGrid.innerHTML = '<div></div>'.repeat(timelineCols.length);
        }

        function openDataModal(index) {
            document.getElementById('editIndex').value = index; document.getElementById('unassignedCount').value = 1;
            currentSelections = { group: "", name: [], region: "", project: "", category: "", macro: "", micro: [], task: "", subTask: [] }; currentWorkloads = {};

            let shouldOpenAdvanced = false; // 💡 預設為收合狀態

            if (index !== -1) {
                const row = mainTableData[index];
                currentSelections.group = row.group || ""; currentSelections.name = row.name ? [row.name] : [];
                currentSelections.region = row.region || ""; currentSelections.project = row.project || "";
                currentSelections.category = row.category || ""; currentSelections.macro = row.macro || "";
                currentSelections.micro = row.micro ? row.micro.split(',').map(s => s.trim()).filter(s => s) : [];
                currentSelections.task = row.task || ""; currentSelections.subTask = row.subTask ? row.subTask.split(',').map(s => s.trim()).filter(s => s) : [];
                let n = row.name || '未指定姓名'; currentWorkloads[n] = {};
                timelineCols.forEach(c => { currentWorkloads[n][c.key] = row[c.key] || ""; });

                // 💡 如果是編輯舊資料，且該資料已經有分配組別或姓名，就自動展開進階區塊
                if (row.group || row.name) shouldOpenAdvanced = true;
            }

            // 💡 執行狀態切換
            if (typeof toggleAdvancedScheduling === 'function') {
                toggleAdvancedScheduling(shouldOpenAdvanced ? 'open' : 'close');
            }

            checkWaterfallState(); buildCheckLists(); document.getElementById('dataModal').style.display = 'block';
        }

        function openGroupModal(indices) {
            document.getElementById('editIndex').value = JSON.stringify(indices); document.getElementById('unassignedCount').value = 1;
            currentSelections = { group: "", name: [], region: "", project: "", category: "", macro: "", micro: [], task: "", subTask: [] }; currentWorkloads = {};
            const firstRow = mainTableData[indices[0]];
            currentSelections.group = firstRow.group || ""; currentSelections.region = firstRow.region || "";
            currentSelections.project = firstRow.project || ""; currentSelections.category = firstRow.category || "";
            currentSelections.macro = firstRow.macro || ""; currentSelections.micro = firstRow.micro ? firstRow.micro.split(',').map(s => s.trim()).filter(s => s) : [];
            currentSelections.task = firstRow.task || ""; currentSelections.subTask = firstRow.subTask ? firstRow.subTask.split(',').map(s => s.trim()).filter(s => s) : [];
            indices.forEach(idx => {
                const row = mainTableData[idx]; const n = row.name || "";
                if (n && !currentSelections.name.includes(n)) currentSelections.name.push(n);
                let targetN = n === "" ? "未指定姓名" : n;
                if (!currentWorkloads[targetN]) currentWorkloads[targetN] = {};
                timelineCols.forEach(c => { currentWorkloads[targetN][c.key] = row[c.key] || ""; });
            });
            checkWaterfallState(); buildCheckLists(); document.getElementById('dataModal').style.display = 'block';
        }

        function checkWaterfallState() {
            const hasRegion = currentSelections.region !== ""; const hasProject = currentSelections.project !== ""; const hasCategory = currentSelections.category !== "";
            const blockProject = document.getElementById('block_project'); const blockCategory = document.getElementById('block_category');
            const blockDetails = document.getElementById('block_details'); const btnSave = document.getElementById('btn_save_data');
            blockProject.style.display = hasRegion ? 'flex' : 'none'; blockCategory.style.display = (hasRegion && hasProject) ? 'flex' : 'none';
            if (hasRegion && hasProject && hasCategory) { blockDetails.classList.remove('step-hidden'); btnSave.disabled = false; btnSave.style.opacity = 1; }
            else { blockDetails.classList.add('step-hidden'); btnSave.disabled = true; btnSave.style.opacity = 0.5; }
        }

        function getPersonTaskCount(name) {
            let count = 0; const editIndexVal = document.getElementById('editIndex').value; let skipIndices = [];
            if (editIndexVal && editIndexVal.startsWith('[')) skipIndices = JSON.parse(editIndexVal); else if (editIndexVal) { const idx = parseInt(editIndexVal); if (idx !== -1) skipIndices = [idx]; }
            mainTableData.forEach((row, idx) => { if (skipIndices.includes(idx)) return; if (row.name === name) count++; });
            return count;
        }

        function buildCheckLists() {
            const allGroups = [...new Set(db.groupLinks.map(l => l.group))];
            let allowedNames = currentSelections.group ? db.groupLinks.filter(l => l.group === currentSelections.group).map(l => l.name) : [];
            let validRps = db.rpLinks;
            if (currentSelections.region) validRps = validRps.filter(l => l.region === currentSelections.region);
            if (currentSelections.project) validRps = validRps.filter(l => l.project === currentSelections.project);
            const allMacros = [...new Set(db.processLinks.map(l => l.macro))];
            let allowedMicros = currentSelections.macro ? db.processLinks.filter(l => l.macro === currentSelections.macro).map(l => l.micro) : [];
            let allowedCategories = null;
            if (currentSelections.region && currentSelections.project) {
                const msForRp = db.milestones.filter(m => m.region === currentSelections.region && m.project === currentSelections.project);
                if (msForRp.length > 0) { allowedCategories = [...new Set(msForRp.map(m => m.category))]; if (currentSelections.category && !allowedCategories.includes(currentSelections.category)) { currentSelections.category = ""; setTimeout(checkWaterfallState, 0); } }
            }
            const allTasks = [...new Set(db.taskLinks.map(l => l.task))];
            let allowedSubTasks = currentSelections.task ? db.taskLinks.filter(l => l.task === currentSelections.task).map(l => l.subTask).filter(s => s !== "") : [];

            renderList('cl_region', 'region', [...new Set(db.rpLinks.map(l => l.region))], currentSelections.region, [...new Set(validRps.map(l => l.region))]);
            renderList('cl_project', 'project', [...new Set(db.rpLinks.map(l => l.project))], currentSelections.project, [...new Set(validRps.map(l => l.project))]);
            renderList('cl_category', 'category', ['NPI', 'Ops.'], currentSelections.category, allowedCategories);
            renderList('cl_macro', 'macro', allMacros, currentSelections.macro, null);
            if (!currentSelections.macro) document.getElementById('cl_micro').innerHTML = '<span style="color:#f57c00; font-size:12px; font-weight:bold; grid-column: 1 / -1; margin-top: 5px;">🔒 請先選擇左側的「大製程」以解鎖小製程</span>'; else renderList('cl_micro', 'micro', [...new Set(allowedMicros)], currentSelections.micro, null);
            renderList('cl_task', 'task', allTasks, currentSelections.task, null);
            if (!currentSelections.task) document.getElementById('cl_subTask').innerHTML = '<span style="color:#f57c00; font-size:12px; font-weight:bold; grid-column: 1 / -1; margin-top: 5px;">🔒 請先選擇左側的「主事項」以解鎖小事項</span>'; else renderList('cl_subTask', 'subTask', [...new Set(allowedSubTasks)], currentSelections.subTask, null);
            renderList('cl_group', 'group', allGroups, currentSelections.group, null);
            if (!currentSelections.group) document.getElementById('cl_name').innerHTML = '<span style="color:#f57c00; font-size:12px; font-weight:bold; grid-column: 1 / -1; margin-top: 5px;">🔒 若不選組別，可直接回到主頁下拉選單指派</span>'; else renderList('cl_name', 'name', [...new Set(allowedNames)], currentSelections.name, null);
            renderGanttChart(); renderWorkloadInputs();
        }

        function renderList(containerId, fieldName, fullList, selectedValue, allowedList) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            if (fullList.length === 0) { container.innerHTML = `<span style="color:#aaa; font-size:11px;">尚無設定</span>`; return; }
            fullList.forEach(item => {
                if (!item) return;
                const btn = document.createElement('button'); btn.type = "button";
                const isSelected = Array.isArray(selectedValue) ? selectedValue.includes(item) : item === selectedValue;
                btn.className = `check-btn ${isSelected ? 'active' : ''} ${(!allowedList || allowedList.includes(item)) ? '' : 'disabled'}`;
                if (fieldName === 'name') {
                    const taskCount = getPersonTaskCount(item); const badgeBg = taskCount > 0 ? '#ffe0b2' : '#f5f5f5'; const badgeColor = taskCount > 0 ? '#e65100' : '#888';
                    btn.innerHTML = `<span>${item}</span> <span style="font-size:10px; background:${badgeBg}; color:${badgeColor}; padding:2px 4px; border-radius:10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">事項: ${taskCount}</span>`;
                } else btn.textContent = item;
                btn.onclick = () => handleToggleSelection(fieldName, item);
                container.appendChild(btn);
            });
        }

        function handleToggleSelection(type, value) {
            if (type === 'micro' || type === 'name' || type === 'subTask') {
                const idx = currentSelections[type].indexOf(value);
                if (idx > -1) currentSelections[type].splice(idx, 1); else currentSelections[type].push(value);
            } else {
                if (currentSelections[type] === value) {
                    currentSelections[type] = "";
                    if (type === 'group') currentSelections.name = []; if (type === 'macro') currentSelections.micro = []; if (type === 'task') currentSelections.subTask = [];
                    if (type === 'region') { currentSelections.project = ""; currentSelections.category = ""; }
                    if (type === 'project') { currentSelections.category = ""; }
                } else {
                    currentSelections[type] = value;
                    if (type === 'group') currentSelections.name = []; if (type === 'macro') currentSelections.micro = []; if (type === 'task') currentSelections.subTask = [];
                    if (type === 'region') { const validP = db.rpLinks.filter(l => l.region === value).map(l => l.project); if (!validP.includes(currentSelections.project)) { currentSelections.project = ""; currentSelections.category = ""; } }
                    if (type === 'project') { const validR = db.rpLinks.filter(l => l.project === value).map(l => l.region); if (!validR.includes(currentSelections.region) && validR.length === 1) currentSelections.region = validR[0]; currentSelections.category = ""; }
                }
            }

            const triggerFields = ['region', 'project', 'category', 'macro', 'micro', 'task'];
            if (triggerFields.includes(type)) {
                if (currentSelections.region && currentSelections.project && currentSelections.category) {
                    let matches = mainTableData.filter(row => {
                        if (row.region !== currentSelections.region) return false; if (row.project !== currentSelections.project) return false;
                        if (row.category !== currentSelections.category) return false; if ((row.macro || "") !== (currentSelections.macro || "")) return false;
                        let selMicros = [...currentSelections.micro].sort().join(','); let rowMicros = row.micro ? row.micro.split(',').map(s => s.trim()).sort().join(',') : "";
                        if (selMicros !== rowMicros) return false; if ((row.task || "") !== (currentSelections.task || "")) return false;
                        return true;
                    });
                    if (matches.length > 0) {
                        let first = matches[0];
                        if (first.group) currentSelections.group = first.group;
                        if (first.subTask) { let rowSubs = first.subTask.split(',').map(s => s.trim()).filter(s => s); rowSubs.forEach(s => { if (!currentSelections.subTask.includes(s)) currentSelections.subTask.push(s); }); }
                        matches.forEach(m => {
                            let n = m.name || ""; if (n && !currentSelections.name.includes(n)) currentSelections.name.push(n);
                            let targetN = n === "" ? "未指定姓名" : n;
                            if (!currentWorkloads[targetN]) currentWorkloads[targetN] = {};
                            timelineCols.forEach(c => { if (m[c.key]) currentWorkloads[targetN][c.key] = m[c.key]; });
                        });
                        let matchedIndices = []; mainTableData.forEach((row, idx) => { if (matches.includes(row)) matchedIndices.push(idx); });
                        let currentEditVal = document.getElementById('editIndex').value; let originalIndices = [];
                        if (currentEditVal && currentEditVal.startsWith('[')) originalIndices = JSON.parse(currentEditVal); else if (currentEditVal && currentEditVal !== '-1') originalIndices = [parseInt(currentEditVal)];
                        document.getElementById('editIndex').value = JSON.stringify([...new Set([...originalIndices, ...matchedIndices])]);
                    } else {
                        if (currentSelections.name.length > 0) {
                            if (confirm('查無此設定組合的舊資料。\n是否要清除下方目前選擇的「人員」與「權重分配」？\n\n[確定] 清空並重新分配\n[取消] 保留當前人員設定')) { currentSelections.group = ""; currentSelections.name = []; currentWorkloads = {}; document.getElementById('editIndex').value = '-1'; }
                        }
                    }
                }
            }
            checkWaterfallState(); buildCheckLists();
        }

        window.updateWorkload = function (name, weekKey, val) {
            if (!currentWorkloads[name]) currentWorkloads[name] = {};
            currentWorkloads[name][weekKey] = val;
        }
        function renderWorkloadInputs() {
            const container = document.getElementById('workload_rows'); const countContainer = document.getElementById('unassigned_count_container');
            let names = currentSelections.name.length > 0 ? currentSelections.name : ['未指定姓名'];
            if (currentSelections.name.length === 0) countContainer.style.display = 'flex'; else countContainer.style.display = 'none';
            let html = '';
            names.forEach(n => {
                if (!currentWorkloads[n]) { currentWorkloads[n] = {}; timelineCols.forEach(c => currentWorkloads[n][c.key] = ''); }
                html += `<div class="workload-row" style="grid-template-columns: 80px repeat(${timelineCols.length}, var(--col-width));">`;

                // 💡 修正：加深邊框顏色與陰影，讓捲動時的邊界更清晰
                html += `<div class="workload-row-name" title="點擊清除" style="cursor:pointer; position:sticky; left:0; z-index:40; background:#f0f8ff; border-right:2px solid #94a3b8; box-shadow: 3px 0 6px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center;" onclick="clearPersonWorkload('${n}')">${n}</div>`;

                timelineCols.forEach(c => {
                    let val = currentWorkloads[n][c.key] || '';
                    html += `<div style="padding:0 1px;"><input type="number" class="workload-input-modal" value="${val}" min="0.1" max="1" step="0.05" oninput="updateWorkload('${n}', '${c.key}', this.value)" style="border-right:1px solid #eee;"></div>`;
                });
                html += `</div>`;
            });
            container.innerHTML = html;
        }


        window.clearPersonWorkload = function (name) {
            if (confirm(`確定要清除「${name}」的所有權重分配嗎？`)) { if (currentWorkloads[name]) { timelineCols.forEach(c => currentWorkloads[name][c.key] = ''); renderWorkloadInputs(); } }
        }
        window.clearWeekWorkload = function (weekKey) {
            if (confirm(`確定要清除「所有人」在該週的分配嗎？`)) { let names = currentSelections.name.length > 0 ? currentSelections.name : ['未指定姓名']; names.forEach(n => { if (currentWorkloads[n]) currentWorkloads[n][weekKey] = ''; }); renderWorkloadInputs(); }
        }

        function renderGanttChart() {
            const parent = document.getElementById('gantt_container_parent');
            const barsContainer = document.getElementById('gantt_bars');
            const container = document.getElementById('gantt_container');
            barsContainer.innerHTML = '';

            // 💡 修正位置：強制讓進度條父容器的寬度與左邊距，精準貼合下方的 Wk 欄位
            parent.style.width = `calc(var(--col-width) * ${timelineCols.length})`;
            parent.style.marginLeft = '80px';

            if (!currentSelections.region || !currentSelections.project || !currentSelections.category) { parent.style.display = 'none'; return; }
            let ms = db.milestones.filter(m => m.region === currentSelections.region && m.project === currentSelections.project && m.category === currentSelections.category);
            if (ms.length === 0) { parent.style.display = 'none'; return; }
            parent.style.display = 'block'; ms.sort((a, b) => new Date(a.start) - new Date(b.start));

            const duration = timelineEndMs - timelineStartMs;
            let lanes = [];

            ms.forEach(m => {
                // 確保精準抓到一天的一頭一尾，解決對齊誤差
                const startT = new Date(m.start).setHours(0, 0, 0, 0);
                const endT = new Date(m.end).setHours(23, 59, 59, 999);
                if (endT < timelineStartMs || startT > timelineEndMs) return;

                let renderStart = Math.max(startT, timelineStartMs);
                let renderEnd = Math.min(endT, timelineEndMs);

                let leftPct = ((renderStart - timelineStartMs) / duration) * 100;
                let widthPct = ((renderEnd - renderStart) / duration) * 100;

                let assignedLane = -1;
                for (let i = 0; i < lanes.length; i++) { if (lanes[i] < renderStart) { assignedLane = i; lanes[i] = renderEnd; break; } }
                if (assignedLane === -1) { lanes.push(renderEnd); assignedLane = lanes.length - 1; }

                const topPos = assignedLane * 20 + 2;
                const sd = new Date(m.start); const ed = new Date(m.end);
                const strStart = `${sd.getMonth() + 1}/${sd.getDate()}`; const strEnd = `${ed.getMonth() + 1}/${ed.getDate()}`;
                const bar = document.createElement('div');

                // 💡 修正顏色：直接利用行內樣式賦予 NPI / Ops. 不同的主題色
                let bgColor = m.category === 'NPI' ? '#e1f5fe' : '#e8f5e9';
                let textColor = m.category === 'NPI' ? '#0288d1' : '#2e7d32';
                let borderColor = m.category === 'NPI' ? '#81d4fa' : '#a5d6a7';

                bar.className = `gantt-bar`;
                bar.style.left = `${leftPct}%`;
                bar.style.width = `${widthPct}%`;
                bar.style.top = `${topPos}px`;
                bar.style.backgroundColor = bgColor;
                bar.style.border = `1px solid ${borderColor}`;
                bar.style.color = textColor;
                bar.style.textShadow = 'none'; // 覆蓋掉預設的文字顏色

                bar.title = `[${m.category}] ${m.phase} (${m.start}~${m.end})`;
                bar.innerHTML = `<span style="color:${textColor}">${strStart}</span><b style="color:${textColor}">${m.phase}</b><span style="color:${textColor}">${strEnd}</span>`;
                barsContainer.appendChild(bar);
            });
            container.style.height = `${Math.max(40, lanes.length * 20 + 6)}px`;
        }

        function saveDataRow() {
            let isFormValid = true; document.querySelectorAll('.workload-input-modal').forEach(el => { if (el.value && !el.checkValidity()) { isFormValid = false; el.reportValidity(); } });
            if (!isFormValid) return;
            const editIndexVal = document.getElementById('editIndex').value; let indicesToRemove = [];
            if (editIndexVal && editIndexVal.startsWith('[')) indicesToRemove = JSON.parse(editIndexVal); else if (editIndexVal && editIndexVal !== '-1') indicesToRemove = [parseInt(editIndexVal)];
            let namesToSave = currentSelections.name.length > 0 ? currentSelections.name : [];
            if (namesToSave.length === 0) { for (let i = 0; i < (parseInt(document.getElementById('unassignedCount').value) || 1); i++) namesToSave.push(''); }
            let splitFactor = (currentSelections.micro.length || 1) * (currentSelections.subTask.length || 1);
            let baseExistingRow = {};
            if (indicesToRemove.length > 0 && mainTableData[indicesToRemove[0]]) {
                Object.keys(mainTableData[indicesToRemove[0]]).forEach(k => { if (k.startsWith('y') && !timelineCols.find(c => c.key === k)) baseExistingRow[k] = mainTableData[indicesToRemove[0]][k]; });
            }
            let newRows = [];
            namesToSave.forEach(n => {
                (currentSelections.micro.length ? currentSelections.micro : ['']).forEach(m => {
                    (currentSelections.subTask.length ? currentSelections.subTask : ['']).forEach(s => {
                        let row = { ...baseExistingRow, _id: Date.now() + Math.floor(Math.random() * 100000), region: currentSelections.region, project: currentSelections.project, category: currentSelections.category, macro: currentSelections.macro, micro: m, task: currentSelections.task, subTask: s, group: currentSelections.group, name: n };
                        let targetN = n === "" ? "未指定姓名" : n;
                        timelineCols.forEach(c => {
                            let val = currentWorkloads[targetN] ? currentWorkloads[targetN][c.key] : "";
                            if (val && splitFactor > 1) row[c.key] = Math.round((parseFloat(val) / splitFactor) * 100) / 100; else row[c.key] = val;
                        });
                        newRows.push(row);
                    });
                });
            });
            if (indicesToRemove.length > 0) { const insertPos = Math.min(...indicesToRemove); indicesToRemove.sort((a, b) => b - a).forEach(idx => mainTableData.splice(idx, 1)); mainTableData.splice(insertPos, 0, ...newRows); } else { mainTableData.push(...newRows); }
            saveAllStorage(); renderMainTable(); closeModal('dataModal');
        }

        // ================= 主渲染 =================
        function renderMainTable() {
            updateMainFilterOptions();
            let thead = document.querySelector('#mainTable thead');
            thead.innerHTML = '<tr id="monthTheadTr"></tr><tr id="mainTheadTr"></tr>';
            const monthTr = document.getElementById('monthTheadTr');
            const theadTr = document.getElementById('mainTheadTr');
            const tbody = document.querySelector('#mainTable tbody'); tbody.innerHTML = '';
            let tfoot = document.querySelector('#mainTable tfoot');
            if (!tfoot) { tfoot = document.createElement('tfoot'); document.getElementById('mainTable').appendChild(tfoot); }
            tfoot.innerHTML = '';

            const colDefs = {
                region: { title: '地區', cls: 'col-region', bg: '' }, project: { title: '專案', cls: 'col-project', bg: '' },
                category: { title: '類別', cls: 'col-category', bg: 'background:#fff3e0;' }, macro: { title: '大製程', cls: 'col-macro', bg: 'background:#e0f2f1;' },
                micro: { title: '小製程', cls: 'col-micro', bg: 'background:#e0f2f1;' }, task: { title: '主事項', cls: 'col-task', bg: 'background:#e8f5e9;' },
                subTask: { title: '小事項', cls: 'col-subtask', bg: 'background:#e8f5e9;' }, group: { title: '組別', cls: 'col-group', bg: '' }, name: { title: '姓名', cls: 'col-name', bg: '' }
            };

            colOrder.forEach(col => {
                let def = colDefs[col];
                monthTr.innerHTML += `<th rowspan="2" class="sortable ${def.cls}" style="${def.bg} border-bottom: 1px solid #ddd; vertical-align: middle;" data-col="${col}" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropCol(event)" onclick="handleSort('${col}')" title="可拖曳排序欄位">${def.title}</th>`;
            });

            let monthFlexHtml = `<div style="display: flex; width: 100%; height: 100%;">`;
            timelineMonths.forEach(m => {
                monthFlexHtml += `<div style="width: ${m.widthPct}%; border-right: 1px solid #90caf9; display: flex; align-items: center; justify-content: center; background-color: #e3f2fd; color: #0277bd; font-size: 13px; font-weight: bold; box-sizing: border-box;">${m.label}</div>`;
            });
            monthFlexHtml += `</div>`;
            monthTr.innerHTML += `<th colspan="${timelineCols.length}" style="padding: 0; border-bottom: 2px solid #bbdefb; border-right: none;">${monthFlexHtml}</th>`;

            timelineCols.forEach(c => {
                let labelHtml = `${c.label}<br><span style="font-size: 9px; font-weight: normal; color: #78909c;">${c.subLabel}</span>`;
                theadTr.innerHTML += `<th class="sortable time-col" onclick="handleSort('${c.key}')" style="line-height: 1.2;">${labelHtml}</th>`;
            });

            const showFlags = {
                region: document.getElementById('toggleRegion').checked, project: document.getElementById('toggleProject').checked,
                category: document.getElementById('toggleCategory').checked, macro: document.getElementById('toggleMacro').checked,
                micro: document.getElementById('toggleMicro').checked, task: document.getElementById('toggleTask').checked,
                subTask: document.getElementById('toggleSubTask').checked, group: document.getElementById('toggleGroup').checked,
                name: document.getElementById('toggleName').checked
            };

            if (mainTableData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colOrder.length + timelineCols.length}" style="color:#888; padding: 20px;">目前是空的，請點擊上方「新增專案/任務」。</td></tr>`;
                applyColumnToggleDisplay(showFlags); return;
            }

            const f_reg = document.getElementById('flt_region').value; const f_proj = document.getElementById('flt_project').value;
            const f_cat = document.getElementById('flt_category').value; const f_mac = document.getElementById('flt_macro').value;
            const f_grp = document.getElementById('flt_group').value; const f_kw = document.getElementById('flt_keyword').value.toLowerCase();

            let filteredData = mainTableData.filter((row, originalIndex) => {
                row._originalIndex = originalIndex;
                if (f_reg && row.region !== f_reg) return false; if (f_proj && row.project !== f_proj) return false;
                if (f_cat && row.category !== f_cat) return false; if (f_mac && row.macro !== f_mac) return false;
                if (f_grp && row.group !== f_grp) return false;
                if (f_kw && !`${row.name || ''} ${row.micro || ''} ${row.task || ''} ${row.subTask || ''}`.toLowerCase().includes(f_kw)) return false;
                return true;
            });

            const isAggregated = Object.values(showFlags).some(v => !v);
            const isOnlyNameHidden = !showFlags.name && showFlags.region && showFlags.project && showFlags.category && showFlags.macro && showFlags.micro && showFlags.group && showFlags.task && showFlags.subTask;
            let displayData = [];

            if (!isAggregated) {
                displayData = filteredData.map(row => ({ ...row, originalIndex: row._originalIndex }));
            } else {
                let grouped = {};
                filteredData.forEach((row) => {
                    let key = colOrder.map(col => showFlags[col] ? (row[col] || "") : "-").join('|');
                    if (!grouped[key]) {
                        grouped[key] = { isGrouped: true, originalIndices: [] };
                        timelineCols.forEach(c => grouped[key][c.key] = 0);
                        colOrder.forEach(col => grouped[key][col] = showFlags[col] ? (row[col] || "") : "");
                    }
                    grouped[key].originalIndices.push(row._originalIndex);
                    timelineCols.forEach(c => { grouped[key][c.key] += parseFloat(row[c.key]) || 0; });
                });
                displayData = Object.values(grouped).map(row => {
                    timelineCols.forEach(c => { if (row[c.key] > 0) row[c.key] = Math.round(row[c.key] * 100) / 100; else row[c.key] = ""; });
                    return row;
                });
            }

            displayData.sort((a, b) => {
                if (currentSort.column) {
                    if (currentSort.column.startsWith('y') && currentSort.column.includes('_w')) {
                        return currentSort.direction === 'asc' ? parseFloat(a[currentSort.column] || 0) - parseFloat(b[currentSort.column] || 0) : parseFloat(b[currentSort.column] || 0) - parseFloat(a[currentSort.column] || 0);
                    } else {
                        return currentSort.direction === 'asc' ? String(a[currentSort.column] || "").localeCompare(String(b[currentSort.column] || ""), 'zh-TW') : -String(a[currentSort.column] || "").localeCompare(String(b[currentSort.column] || ""), 'zh-TW');
                    }
                }
                for (let col of colOrder) {
                    let cmp = String(a[col] || "").localeCompare(String(b[col] || ""), 'zh-TW');
                    if (cmp !== 0) return cmp;
                }
                return 0;
            });

            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.getAttribute('onclick') && th.getAttribute('onclick').includes(`'${currentSort.column}'`)) th.classList.add(currentSort.direction);
            });

            const allGroups = [...new Set(db.groupLinks.map(l => l.group))];
            const allMacros = [...new Set(db.processLinks.map(l => l.macro))];
            const allTasks = [...new Set(db.taskLinks.map(t => t.task))];

            const phaseCache = {};
            db.milestones.forEach(m => {
                if (!m.start || !m.end) return;
                let rpcKey = `${m.region}|${m.project}|${m.category}`;
                if (!phaseCache[rpcKey]) phaseCache[rpcKey] = [];
                phaseCache[rpcKey].push(m);
            });

            displayData.forEach((row) => {
                let tr = document.createElement('tr');
                if (row.isGrouped) {
                    if (isOnlyNameHidden) { tr.dataset.groupIndices = JSON.stringify(row.originalIndices); tr.dataset.type = 'group'; } else { tr.dataset.type = 'readonly'; }
                } else { tr.dataset.index = row.originalIndex; tr.dataset.type = 'single'; }

                let cellsHtml = '';

                colOrder.forEach(col => {
                    let tdClass = colDefs[col].cls;
                    let isGrp = row.isGrouped;

                    // 💡 左半部終極對齊：強制下拉選單在唯讀時移除箭頭並變成一般文字顏色
                    let sStyle = isGrp ? 'pointer-events:none; color:#333; font-weight:normal; background-image:none !important; border-color:transparent !important; -webkit-appearance:none; appearance:none;' : '';
                    let sAttr = isGrp ? 'tabindex="-1"' : '';

                    // 💡 左半部終極對齊：讓地區、專案等純文字的 Padding 佈局跟下拉選單一模一樣！
                    let textWrapperStart = `<div style="font-size:13px; padding:2px 16px 2px 8px; border:1px solid transparent; display:flex; align-items:center; justify-content:center; color:#333; white-space:nowrap;">`;
                    let textWrapperEnd = `</div>`;

                    if (col === 'category') {
                        let catHtml = row.category === 'NPI' ? `<span class="tag-npi">NPI</span>` : (row.category === 'Ops.' ? `<span class="tag-mp">Ops.</span>` : (row.category || ""));
                        cellsHtml += `<td class="${tdClass}">${textWrapperStart}${catHtml}${textWrapperEnd}</td>`;
                    }
                    else if (col === 'macro') {
                        let onChg = isGrp ? '' : `onchange="updateRowField(${row.originalIndex}, 'macro', this.value)"`;
                        cellsHtml += `<td class="${tdClass}"><select class="inline-select" style="${sStyle}" ${sAttr} ${onChg}><option value="">未指定</option>${allMacros.map(x => `<option value="${x}" ${row.macro === x ? 'selected' : ''}>${x}</option>`).join('')}</select></td>`;
                    }
                    else if (col === 'micro') {
                        let vMic = row.macro ? [...new Set(db.processLinks.filter(l => l.macro === row.macro).map(l => l.micro).filter(s => s))] : [];
                        let onChg = isGrp ? '' : `onchange="updateRowField(${row.originalIndex}, 'micro', this.value)"`;
                        cellsHtml += `<td class="${tdClass}"><select class="inline-select" style="${sStyle}" ${sAttr} ${onChg}>${row.macro ? `<option value="">未指定</option>` + vMic.map(x => `<option value="${x}" ${row.micro === x ? 'selected' : ''}>${x}</option>`).join('') : `<option value="">請先選大製程</option>`}</select></td>`;
                    }
                    else if (col === 'task') {
                        let onChg = isGrp ? '' : `onchange="updateRowField(${row.originalIndex}, 'task', this.value)"`;
                        cellsHtml += `<td class="${tdClass}"><select class="inline-select" style="${sStyle}" ${sAttr} ${onChg}><option value="">未指定</option>${allTasks.map(x => `<option value="${x}" ${row.task === x ? 'selected' : ''}>${x}</option>`).join('')}</select></td>`;
                    }
                    else if (col === 'subTask') {
                        let vSub = row.task ? [...new Set(db.taskLinks.filter(t => t.task === row.task).map(t => t.subTask).filter(s => s))] : [];
                        let onChg = isGrp ? '' : `onchange="updateRowField(${row.originalIndex}, 'subTask', this.value)"`;
                        cellsHtml += `<td class="${tdClass}"><select class="inline-select" style="${sStyle}" ${sAttr} ${onChg}>${row.task ? `<option value="">未指定</option>` + vSub.map(x => `<option value="${x}" ${row.subTask === x ? 'selected' : ''}>${x}</option>`).join('') : `<option value="">請先選主事項</option>`}</select></td>`;
                    }
                    else if (col === 'group') {
                        let onChg = isGrp ? '' : `onchange="updateRowField(${row.originalIndex}, 'group', this.value)"`;
                        cellsHtml += `<td class="${tdClass}"><select class="inline-select" style="${sStyle}" ${sAttr} ${onChg}><option value="">未指定</option>${allGroups.map(x => `<option value="${x}" ${row.group === x ? 'selected' : ''}>${x}</option>`).join('')}</select></td>`;
                    }
                    else if (col === 'name') {
                        let vName = row.group ? [...new Set(db.groupLinks.filter(l => l.group === row.group).map(l => l.name))] : [];
                        let onChg = isGrp ? '' : `onchange="updateRowField(${row.originalIndex}, 'name', this.value)"`;
                        cellsHtml += `<td class="${tdClass}"><select class="inline-select" style="${sStyle}" ${sAttr} ${onChg}>${row.group ? `<option value="">未指定</option>` + vName.map(x => `<option value="${x}" ${row.name === x ? 'selected' : ''}>${x}</option>`).join('') : `<option value="">請先選組別</option>`}</select></td>`;
                    }
                    else {
                        cellsHtml += `<td class="${tdClass}">${textWrapperStart}${row[col] || ""}${textWrapperEnd}</td>`;
                    }
                });

                let rowPhases = [];
                if (row.region && row.project && row.category && row.region !== "-" && row.project !== "-" && row.category !== "-") {
                    let rpcKey = `${row.region}|${row.project}|${row.category}`;
                    rowPhases = phaseCache[rpcKey] || [];
                }

                let maxLaneIndex = -1;
                let rowLanes = [];
                let validPhases = [];

                rowPhases.forEach(m => {
                    let mStart = new Date(m.start).setHours(0, 0, 0, 0);
                    let mEnd = new Date(m.end).setHours(23, 59, 59, 999);
                    if (mEnd >= timelineStartMs && mStart <= timelineEndMs) {
                        validPhases.push({ ...m, mStart, mEnd });
                        let renderStart = Math.max(mStart, timelineStartMs);
                        let renderEnd = Math.min(mEnd, timelineEndMs);

                        let lIndex = -1;
                        for (let i = 0; i < rowLanes.length; i++) { if (rowLanes[i] < renderStart) { lIndex = i; rowLanes[i] = renderEnd; break; } }
                        if (lIndex === -1) { rowLanes.push(renderEnd); lIndex = rowLanes.length - 1; }
                        if (lIndex > maxLaneIndex) maxLaneIndex = lIndex;
                    }
                });

                let paddingTop = maxLaneIndex >= 0 ? ((maxLaneIndex + 1) * 20 + 4) : 2;

                timelineCols.forEach((c, idx) => {
                    let phasesHtml = "";
                    if (idx === 0) {
                        phasesHtml = `<div style="position:absolute; top:0; left:0; width:0; height:100%; z-index:5; pointer-events:none; overflow:visible;">`;
                        let drawingLanes = [];

                        validPhases.forEach(m => {
                            let renderStart = Math.max(m.mStart, timelineStartMs);
                            let renderEnd = Math.min(m.mEnd, timelineEndMs);

                            let lIndex = -1;
                            for (let i = 0; i < drawingLanes.length; i++) { if (drawingLanes[i] < renderStart) { lIndex = i; drawingLanes[i] = renderEnd; break; } }
                            if (lIndex === -1) { drawingLanes.push(renderEnd); lIndex = drawingLanes.length - 1; }

                            let startOffsetDays = (renderStart - timelineStartMs) / 86400000;
                            let durationDays = (renderEnd - renderStart) / 86400000;

                            let leftStr = `calc((var(--col-width) + 1px) * ${startOffsetDays / 7})`;
                            let widthStr = `calc((var(--col-width) + 1px) * ${durationDays / 7} - 1px)`;

                            let bgColor = m.category === 'NPI' ? '#e1f5fe' : '#e8f5e9';
                            let textColor = m.category === 'NPI' ? '#0288d1' : '#2e7d32';
                            let borderColor = m.category === 'NPI' ? '#81d4fa' : '#a5d6a7';
                            let topPos = lIndex * 20 + 2;

                            phasesHtml += `<div class="phase-bar" title="[${m.category}] ${m.phase} (${m.start}~${m.end})" style="top: ${topPos}px; left: ${leftStr}; width: ${widthStr}; background: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor}; border-radius: 3px;">&nbsp;${m.phase}</div>`;
                        });
                        phasesHtml += `</div>`;
                    }

                    let hasPhase = validPhases.some(m => c.startMs <= m.mEnd && c.endMs >= m.mStart);
                    let bgStyle = hasPhase ? "background-color: #fafcff;" : "";

                    let val = row[c.key] || "";
                    if (row.isGrouped) {
                        // 💡 右半部終極對齊：使用 <input disabled> 讓框線體積與平常輸入框完全吻合，並透過 CSS 強制黑字顯示
                        cellsHtml += `<td class="time-col" style="padding-top: ${paddingTop}px !important; ${bgStyle}">${phasesHtml}<input type="text" class="inline-workload-input val-span" value="${val}" disabled style="color:#333; font-weight:bold; background:transparent; border-color:transparent; opacity:1; -webkit-text-fill-color:#333; cursor:default;"></td>`;
                    } else {
                        cellsHtml += `<td class="time-col" style="padding-top: ${paddingTop}px !important; ${bgStyle}">${phasesHtml}<input type="number" class="inline-workload-input" value="${val}" min="0.1" max="1" step="0.05" onchange="updateInlineWorkload(${row.originalIndex}, '${c.key}', this.value)"></td>`;
                    }
                });

                tr.innerHTML = cellsHtml;
                tbody.appendChild(tr);
            });

            let totals = {};
            timelineCols.forEach(c => totals[c.key] = 0);
            displayData.forEach(row => {
                timelineCols.forEach(c => { totals[c.key] += (parseFloat(row[c.key]) || 0); });
            });

            const firstVisibleId = colOrder.find(c => showFlags[c]) || 'none';
            let footerHtml = `<tr>`;
            colOrder.forEach(col => {
                let text = col === firstVisibleId ? '當前總計 ➔' : '';
                footerHtml += `<td class="${colDefs[col].cls}" style="background-color: #ffe082; font-weight: bold; color: #d84315; text-align: right; border-top: 2px solid #ffb300; border-bottom: 1px solid #ddd;">${text}</td>`;
            });
            timelineCols.forEach(c => {
                let sum = Math.round(totals[c.key] * 100) / 100;
                footerHtml += `<td id="footer_${c.key}" style="font-weight: bold; color: #d84315; background-color: #fff8e1; border-top: 2px solid #ffb300; border-bottom: 1px solid #ddd;">${sum > 0 ? sum : ""}</td>`;
            });
            footerHtml += `</tr>`;
            tfoot.innerHTML = footerHtml;

            applyColumnToggleDisplay(showFlags);
        }

        // ================= 動態凍結欄位邏輯 =================
        function updateStickyColumns() {
            requestAnimationFrame(() => {
                const table = document.getElementById('mainTable');
                if (!table) return;
                const monthTr = document.getElementById('monthTheadTr');
                const tfootTr = table.querySelector('tfoot tr');
                const tbodyTrs = table.querySelectorAll('tbody tr');

                if (!monthTr) return;

                let currentLeft = 0;
                let lastVisibleIndex = -1;

                for (let i = 0; i < colOrder.length; i++) {
                    // 💡 增加安全檢查：避免因為表格更新中導致抓不到儲存格而報錯
                    if (!monthTr.cells[i]) continue;
                    if (window.getComputedStyle(monthTr.cells[i]).display !== 'none') lastVisibleIndex = i;
                }

                for (let i = 0; i < colOrder.length; i++) {
                    // 💡 增加安全檢查
                    if (!monthTr.cells[i]) continue;
                    const isVisible = window.getComputedStyle(monthTr.cells[i]).display !== 'none';

                    // 💡 精準讀取寬度，避免出現 1px 的滾動黑線或模糊
                    let exactWidth = isVisible ? monthTr.cells[i].getBoundingClientRect().width : 0;

                    const processCell = (cell, isHeader, isFooter) => {
                        if (!cell) return;
                        if (isVisible) {
                            cell.style.position = 'sticky';
                            cell.style.left = currentLeft + 'px';

                            if (isHeader) cell.style.zIndex = '55';
                            else if (isFooter) cell.style.zIndex = '45';
                            else cell.style.zIndex = '40';

                            if (!isHeader && !isFooter) cell.style.backgroundColor = 'inherit';

                            if (currentLeft === 0) cell.style.borderLeft = '1px solid #ddd';
                            else cell.style.borderLeft = 'none';

                            if (i === lastVisibleIndex) {
                                cell.style.borderRight = '2px solid #90caf9';
                                if (isFooter) cell.style.boxShadow = '2px -2px 5px rgba(0,0,0,0.1)';
                                else cell.style.boxShadow = '2px 0 5px rgba(0,0,0,0.08)';
                            } else {
                                cell.style.borderRight = '1px solid #ddd';
                                if (isFooter) cell.style.boxShadow = '0 -2px 5px rgba(0,0,0,0.1)';
                                else cell.style.boxShadow = 'none';
                            }
                        } else {
                            cell.style.position = ''; cell.style.left = ''; cell.style.zIndex = '';
                            cell.style.borderRight = ''; cell.style.borderLeft = ''; cell.style.boxShadow = '';
                        }
                    };

                    if (monthTr && monthTr.cells[i]) processCell(monthTr.cells[i], true, false);
                    if (tfootTr && tfootTr.cells[i]) processCell(tfootTr.cells[i], false, true);
                    tbodyTrs.forEach(tr => { if (tr.cells[i]) processCell(tr.cells[i], false, false); });

                    if (isVisible) currentLeft += exactWidth;
                }
            });
        }
        window.addEventListener('resize', updateStickyColumns);

        // ================= DB 管理 =================
        function switchDbTab(tab) {
            document.querySelectorAll('.db-tab-btn').forEach(b => {
                b.classList.remove('active');
                if (b.innerText.includes('事項綁定') && tab === 'task') b.style.backgroundColor = '#4CAF50';
                else if (b.innerText.includes('事項綁定')) b.style.backgroundColor = '#e8f5e9';
                else if (b.innerText.includes('大小製程') && tab === 'process') b.style.backgroundColor = '#00695c';
                else if (b.innerText.includes('大小製程')) b.style.backgroundColor = '#e0f2f1';
                else b.style.backgroundColor = '';
            });
            document.querySelectorAll('.db-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab_' + tab).classList.add('active');
            if (tab !== 'task' && tab !== 'process') event.target.classList.add('active'); else event.target.style.color = 'white';
        }

        function openDbModal() { updateFilterDropdowns(); applyRpFilter(); applyMilestoneFilter(); applyProcessFilter(); applyGroupFilter(); applyTaskFilter(); document.getElementById('dbModal').style.display = 'block'; }
        function updateFilterDropdowns() {
            const msRpSelect = document.getElementById('ms_rp'); const currentMsRp = msRpSelect.value;
            msRpSelect.innerHTML = `<option value="">-- 選擇地區/專案 --</option>` + db.rpLinks.map(l => `<option value="${l.region}|${l.project}">${l.region} - ${l.project}</option>`).join('');
            msRpSelect.value = currentMsRp;
            const setDl = (id, arr) => document.getElementById(id).innerHTML = [...new Set(arr)].map(x => `<option value="${x}">`).join('');
            setDl('dl_groups', db.groupLinks.map(l => l.group)); setDl('dl_names', db.groupLinks.map(l => l.name));
            setDl('dl_regions', db.rpLinks.map(l => l.region)); setDl('dl_projects', db.rpLinks.map(l => l.project));
            setDl('dl_macros', db.processLinks.map(l => l.macro)); setDl('dl_micros', db.processLinks.map(l => l.micro));
            setDl('dl_tasks', db.taskLinks.map(l => l.task));
        }

        function applyRpFilter() {
            const f_reg = document.getElementById('rp_region').value.toLowerCase(); const f_proj = document.getElementById('rp_project').value.toLowerCase();
            const tbody = document.getElementById('db_rp_list'); tbody.innerHTML = '';
            db.rpLinks.forEach((l, i) => {
                if (f_reg && !l.region.toLowerCase().includes(f_reg)) return; if (f_proj && !l.project.toLowerCase().includes(f_proj)) return;
                tbody.innerHTML += `<tr>
					<td>${l.region}</td>
					<td>${l.project}</td>
					<td style="width: 130px; min-width: 130px; text-align: right; white-space: nowrap;">
						<button style="background:#3b82f6; padding:4px 10px; font-size:12px; margin-right:4px;" onclick="startEditDb('rp', ${i})">編輯</button>
						<button style="background:#ef4444; padding:4px 10px; font-size:12px;" onclick="delDb('rp', ${i})">刪除</button>
					</td>
				</tr>`;
            });
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888;">查無資料</td></tr>';
        }
        function addDbRpLink() {
            const r = document.getElementById('rp_region').value.trim(); const p = document.getElementById('rp_project').value.trim();
            if (r && p) { if (!db.rpLinks.find(x => x.region === r && x.project === p)) db.rpLinks.push({ region: r, project: p }); document.getElementById('rp_project').value = ''; saveAllStorage(); applyRpFilter(); updateFilterDropdowns(); } else { alert("請輸入地區與專案名稱！"); }
        }

        function applyMilestoneFilter() {
            const f_rp = document.getElementById('ms_rp').value; const f_cat = document.getElementById('ms_category').value;
            const tbody = document.getElementById('db_milestone_list'); tbody.innerHTML = '';
            let filteredMs = db.milestones.filter(l => { if (f_rp) { const [r, p] = f_rp.split('|'); if (l.region !== r || l.project !== p) return false; } if (f_cat && l.category !== f_cat) return false; return true; });
            filteredMs.sort((a, b) => new Date(a.start) - new Date(b.start));
            filteredMs.forEach(l => {
                const tagClass = l.category === 'NPI' ? 'tag-npi' : 'tag-mp'; const originalIndex = db.milestones.indexOf(l);
                tbody.innerHTML += `<tr>
					<td>${l.region}</td><td>${l.project}</td><td><span class="${tagClass}">${l.category}</span></td><td style="font-weight:bold;">${l.phase}</td><td>${l.start}</td><td>${l.end}</td>
					<td style="width: 130px; min-width: 130px; text-align: right; white-space: nowrap;">
						<button style="background:#3b82f6; padding:4px 10px; font-size:12px; margin-right:4px;" onclick="startEditDb('milestone', ${originalIndex})">編輯</button>
						<button style="background:#ef4444; padding:4px 10px; font-size:12px;" onclick="delDb('milestone', ${originalIndex})">刪除</button>
					</td>
				</tr>`;
            });
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#888;">查無資料</td></tr>';
        }
        function addDbMilestone() {
            const rpVal = document.getElementById('ms_rp').value; const cat = document.getElementById('ms_category').value;
            const ph = document.getElementById('ms_phase').value.trim(); const st = document.getElementById('ms_start').value; const ed = document.getElementById('ms_end').value;
            if (!rpVal || !cat) { alert("請先選擇【地區/專案】與【類別】作為綁定目標！"); return; }
            if (ph && st && ed) { const [r, p] = rpVal.split('|'); if (new Date(st) > new Date(ed)) { alert("開始時間不能晚於結束時間！"); return; } db.milestones.push({ region: r, project: p, category: cat, phase: ph, start: st, end: ed }); document.getElementById('ms_phase').value = ''; saveAllStorage(); applyMilestoneFilter(); } else { alert("請填寫「階段名稱」並指定「起訖日期」！"); }
        }

        function applyProcessFilter() {
            const f_mac = document.getElementById('proc_macro').value.toLowerCase(); const f_mic = document.getElementById('proc_micro').value.toLowerCase();
            const tbody = document.getElementById('db_process_list'); tbody.innerHTML = '';
            db.processLinks.forEach((l, i) => {
                if (f_mac && !l.macro.toLowerCase().includes(f_mac)) return; if (f_mic && !f_mic.includes(',') && !l.micro.toLowerCase().includes(f_mic)) return;
                tbody.innerHTML += `<tr>
					<td>${l.macro}</td><td>${l.micro}</td>
					<td style="width: 130px; min-width: 130px; text-align: right; white-space: nowrap;">
						<button style="background:#3b82f6; padding:4px 10px; font-size:12px; margin-right:4px;" onclick="startEditDb('process', ${i})">編輯</button>
						<button style="background:#ef4444; padding:4px 10px; font-size:12px;" onclick="delDb('process', ${i})">刪除</button>
					</td>
				</tr>`;
            });
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888;">查無資料</td></tr>';
        }
        function addDbProcessLink() {
            const mac = document.getElementById('proc_macro').value.trim(); const mic_raw = document.getElementById('proc_micro').value.trim();
            if (mac) { if (mic_raw) { mic_raw.split(',').map(i => i.trim()).filter(i => i !== "").forEach(mic => { if (!db.processLinks.find(x => x.macro === mac && x.micro === mic)) db.processLinks.push({ macro: mac, micro: mic }); }); } else { if (!db.processLinks.find(x => x.macro === mac && x.micro === "")) db.processLinks.push({ macro: mac, micro: "" }); } document.getElementById('proc_micro').value = ''; saveAllStorage(); applyProcessFilter(); updateFilterDropdowns(); } else { alert("至少需輸入大製程！"); }
        }

        function applyGroupFilter() {
            const f_grp = document.getElementById('grp_group').value.toLowerCase(); const f_name = document.getElementById('grp_name').value.toLowerCase();
            const tbody = document.getElementById('db_group_list'); tbody.innerHTML = '';
            db.groupLinks.forEach((l, i) => {
                if (f_grp && !l.group.toLowerCase().includes(f_grp)) return; if (f_name && !f_name.includes(',') && !l.name.toLowerCase().includes(f_name)) return;
                tbody.innerHTML += `<tr>
					<td>${l.group}</td><td>${l.name}</td>
					<td style="width: 130px; min-width: 130px; text-align: right; white-space: nowrap;">
						<button style="background:#3b82f6; padding:4px 10px; font-size:12px; margin-right:4px;" onclick="startEditDb('group', ${i})">編輯</button>
						<button style="background:#ef4444; padding:4px 10px; font-size:12px;" onclick="delDb('group', ${i})">刪除</button>
					</td>
				</tr>`;
            });
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888;">查無資料</td></tr>';
        }
        function addDbGroupLink() {
            const g = document.getElementById('grp_group').value.trim(); const n_raw = document.getElementById('grp_name').value.trim();
            if (g && n_raw) { n_raw.split(',').map(i => i.trim()).filter(i => i !== "").forEach(name => { if (!db.groupLinks.find(x => x.group === g && x.name === name)) db.groupLinks.push({ group: g, name: name }); }); document.getElementById('grp_name').value = ''; saveAllStorage(); applyGroupFilter(); updateFilterDropdowns(); } else { alert("請輸入組別與姓名！"); }
        }

        function applyTaskFilter() {
            const f_main = document.getElementById('task_main').value.toLowerCase(); const f_sub = document.getElementById('task_sub').value.toLowerCase();
            const tbody = document.getElementById('db_task_list'); tbody.innerHTML = '';
            db.taskLinks.forEach((l, i) => {
                if (f_main && !l.task.toLowerCase().includes(f_main)) return; if (f_sub && !f_sub.includes(',') && !l.subTask.toLowerCase().includes(f_sub)) return;
                tbody.innerHTML += `<tr>
					<td>${l.task}</td><td>${l.subTask}</td>
					<td style="width: 130px; min-width: 130px; text-align: right; white-space: nowrap;">
						<button style="background:#3b82f6; padding:4px 10px; font-size:12px; margin-right:4px;" onclick="startEditDb('task', ${i})">編輯</button>
						<button style="background:#ef4444; padding:4px 10px; font-size:12px;" onclick="delDb('task', ${i})">刪除</button>
					</td>
				</tr>`;
            });
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888;">查無資料</td></tr>';
        }
        function addDbTaskLink() {
            const mainT = document.getElementById('task_main').value.trim(); const subT_raw = document.getElementById('task_sub').value.trim();
            if (mainT) { if (subT_raw) { subT_raw.split(',').map(i => i.trim()).filter(i => i !== "").forEach(sub => { if (!db.taskLinks.find(x => x.task === mainT && x.subTask === sub)) db.taskLinks.push({ task: mainT, subTask: sub }); }); } else { if (!db.taskLinks.find(x => x.task === mainT && x.subTask === "")) db.taskLinks.push({ task: mainT, subTask: "" }); } document.getElementById('task_sub').value = ''; saveAllStorage(); applyTaskFilter(); updateFilterDropdowns(); } else { alert("至少需輸入主事項！"); }
        }

        function delDb(type, originalIndex) {
            if (type === 'rp') db.rpLinks.splice(originalIndex, 1); else if (type === 'milestone') db.milestones.splice(originalIndex, 1);
            else if (type === 'process') db.processLinks.splice(originalIndex, 1); else if (type === 'group') db.groupLinks.splice(originalIndex, 1);
            else if (type === 'task') db.taskLinks.splice(originalIndex, 1);
            saveAllStorage();
            if (type === 'rp') { applyRpFilter(); updateFilterDropdowns(); } else if (type === 'milestone') applyMilestoneFilter();
            else if (type === 'process') { applyProcessFilter(); updateFilterDropdowns(); } else if (type === 'group') { applyGroupFilter(); updateFilterDropdowns(); }
            else { applyTaskFilter(); updateFilterDropdowns(); }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function (e) { if (e.target.className === 'modal') e.target.style.display = 'none'; }

        let currentEditDb = { type: null, index: -1 };
        function startEditDb(type, index) {
            currentEditDb = { type: type, index: index }; let body = document.getElementById('editDbBody'); let html = '';
            if (type === 'rp') { html = `<label style="display:block;margin-bottom:10px;">地區：<input type="text" id="edit_reg" value="${db.rpLinks[index].region}" class="workload-input-modal"></label><label style="display:block;">專案：<input type="text" id="edit_proj" value="${db.rpLinks[index].project}" class="workload-input-modal"></label>`; }
            else if (type === 'process') { html = `<label style="display:block;margin-bottom:10px;">大製程：<input type="text" id="edit_mac" value="${db.processLinks[index].macro}" class="workload-input-modal"></label><label style="display:block;">小製程：<input type="text" id="edit_mic" value="${db.processLinks[index].micro}" class="workload-input-modal"></label>`; }
            else if (type === 'group') { html = `<label style="display:block;margin-bottom:10px;">組別：<input type="text" id="edit_grp" value="${db.groupLinks[index].group}" class="workload-input-modal"></label><label style="display:block;">姓名：<input type="text" id="edit_name" value="${db.groupLinks[index].name}" class="workload-input-modal"></label>`; }
            else if (type === 'task') { html = `<label style="display:block;margin-bottom:10px;">主事項：<input type="text" id="edit_main" value="${db.taskLinks[index].task}" class="workload-input-modal"></label><label style="display:block;">小事項：<input type="text" id="edit_sub" value="${db.taskLinks[index].subTask}" class="workload-input-modal"></label>`; }
            else if (type === 'milestone') { html = `<label style="display:block;margin-bottom:10px;">階段名稱：<input type="text" id="edit_ph" value="${db.milestones[index].phase}" class="workload-input-modal"></label><label style="display:block;margin-bottom:10px;">開始時間：<input type="date" id="edit_st" value="${db.milestones[index].start}" class="workload-input-modal"></label><label style="display:block;">結束時間：<input type="date" id="edit_ed" value="${db.milestones[index].end}" class="workload-input-modal"></label>`; }
            body.innerHTML = html; document.getElementById('editDbModal').style.display = 'block';
        }
        function saveDbEdit() {
            const { type, index } = currentEditDb;
            if (type === 'rp') {
                const oldReg = db.rpLinks[index].region; const oldProj = db.rpLinks[index].project;
                const newReg = document.getElementById('edit_reg').value.trim(); const newProj = document.getElementById('edit_proj').value.trim();
                if (!newReg || !newProj) return;
                if (newReg !== oldReg) { mainTableData.forEach(r => { if (r.region === oldReg) r.region = newReg; }); db.rpLinks.forEach(r => { if (r.region === oldReg) r.region = newReg; }); db.milestones.forEach(m => { if (m.region === oldReg) m.region = newReg; }); }
                if (newProj !== oldProj) { mainTableData.forEach(r => { if (r.region === newReg && r.project === oldProj) r.project = newProj; }); db.rpLinks.forEach(r => { if (r.region === newReg && r.project === oldProj) r.project = newProj; }); db.milestones.forEach(m => { if (m.region === newReg && m.project === oldProj) m.project = newProj; }); }
                applyRpFilter();
            } else if (type === 'process') {
                const oldMac = db.processLinks[index].macro; const oldMic = db.processLinks[index].micro;
                const newMac = document.getElementById('edit_mac').value.trim(); const newMic = document.getElementById('edit_mic').value.trim();
                if (!newMac) return;
                if (newMac !== oldMac) { mainTableData.forEach(r => { if (r.macro === oldMac) r.macro = newMac; }); db.processLinks.forEach(p => { if (p.macro === oldMac) p.macro = newMac; }); }
                if (newMic !== oldMic) { mainTableData.forEach(row => { if (row.macro === newMac) { let mics = row.micro ? row.micro.split(',').map(s => s.trim()).filter(s => s) : []; if (oldMic) { let i = mics.indexOf(oldMic); if (i > -1) { if (newMic) mics[i] = newMic; else mics.splice(i, 1); row.micro = mics.join(', '); } } else if (!oldMic && newMic) { if (!mics.includes(newMic)) mics.push(newMic); row.micro = mics.join(', '); } } }); db.processLinks[index].micro = newMic; }
                applyProcessFilter();
            } else if (type === 'group') {
                const oldGrp = db.groupLinks[index].group; const oldName = db.groupLinks[index].name;
                const newGrp = document.getElementById('edit_grp').value.trim(); const newName = document.getElementById('edit_name').value.trim();
                if (!newGrp || !newName) return;
                if (newGrp !== oldGrp) { mainTableData.forEach(r => { if (r.group === oldGrp) r.group = newGrp; }); db.groupLinks.forEach(g => { if (g.group === oldGrp) g.group = newGrp; }); }
                if (newName !== oldName) { mainTableData.forEach(r => { if (r.group === newGrp && r.name === oldName) r.name = newName; }); db.groupLinks[index].name = newName; }
                applyGroupFilter();
            } else if (type === 'task') {
                const oldTask = db.taskLinks[index].task; const oldSub = db.taskLinks[index].subTask;
                const newTask = document.getElementById('edit_main').value.trim(); const newSub = document.getElementById('edit_sub').value.trim();
                if (!newTask) return;
                if (newTask !== oldTask) { mainTableData.forEach(r => { if (r.task === oldTask) r.task = newTask; }); db.taskLinks.forEach(t => { if (t.task === oldTask) t.task = newTask; }); }
                if (newSub !== oldSub) { mainTableData.forEach(row => { if (row.task === newTask) { let subs = row.subTask ? row.subTask.split(',').map(s => s.trim()).filter(s => s) : []; if (oldSub) { let i = subs.indexOf(oldSub); if (i > -1) { if (newSub) subs[i] = newSub; else subs.splice(i, 1); row.subTask = subs.join(', '); } } else if (!oldSub && newSub) { if (!subs.includes(newSub)) subs.push(newSub); row.subTask = subs.join(', '); } } }); db.taskLinks[index].subTask = newSub; }
                applyTaskFilter();
            } else if (type === 'milestone') {
                db.milestones[index] = { ...db.milestones[index], phase: document.getElementById('edit_ph').value.trim(), start: document.getElementById('edit_st').value, end: document.getElementById('edit_ed').value }; applyMilestoneFilter();
            }
            saveAllStorage(); renderMainTable(); updateFilterDropdowns(); closeModal('editDbModal');
        }


        // ==============================================================================
        // ================= 🌟 資源分配矩陣 (Allocation Matrix) 系統 =================
        // ==============================================================================

        let allocTimelineCols = [];

        function initAllocWeekNavigator() {
            let start = new Date(timelineStartMs);
            let end = new Date(timelineEndMs);
            let curr = new Date(start);

            const selector = document.getElementById('allocWeekSelector');
            selector.innerHTML = '';
            allocTimelineCols = [];

            while (curr <= end) {
                let thursday = new Date(curr);
                thursday.setDate(thursday.getDate() + 3);
                let y = thursday.getFullYear();
                let w = getISOWeek(thursday);

                let mon = new Date(curr);
                let sun = new Date(curr); sun.setDate(sun.getDate() + 6);
                let dateStrLong = `${mon.getMonth() + 1}/${mon.getDate()} ~ ${sun.getMonth() + 1}/${sun.getDate()}`;
                let dateStrShort = `${mon.getMonth() + 1}/${mon.getDate()}`;

                let key = `y${y}_w${w}`;
                // 💡 寫入當週真正的起訖毫秒數
                let startMs = mon.setHours(0, 0, 0, 0);
                let endMs = sun.setHours(23, 59, 59, 999);

                allocTimelineCols.push({ key: key, label: `W${w}`, dateStr: dateStrShort, startMs: startMs, endMs: endMs });

                let opt = document.createElement('option');
                opt.value = key;
                opt.textContent = `${y}年 W${w} (${dateStrLong})`;
                selector.appendChild(opt);

                curr.setDate(curr.getDate() + 7);
            }

            let todayThurs = new Date();
            todayThurs.setDate(todayThurs.getDate() + 3 - (todayThurs.getDay() || 7));
            let tKey = `y${todayThurs.getFullYear()}_w${getISOWeek(todayThurs)}`;
            if (selector.querySelector(`option[value="${tKey}"]`)) {
                selector.value = tKey;
            } else {
                selector.selectedIndex = 0;
            }
        }

        function openAllocModal() {
            initAllocWeekNavigator();
            updateAllocView();
            document.getElementById('allocModal').style.display = 'block';
        }

        function changeAllocWeek(offset) {
            const selector = document.getElementById('allocWeekSelector');
            let newIndex = selector.selectedIndex + offset;
            if (newIndex >= 0 && newIndex < selector.options.length) {
                selector.selectedIndex = newIndex;
                updateAllocView();
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            let d = new Date(dateStr);
            return `${d.getMonth() + 1}/${d.getDate()}`;
        }

        function getSmartPhase(region, project, category, currentWeekKey) {
            let msList = db.milestones.filter(m => m.region === region && m.project === project && m.category === category);
            if (msList.length === 0) return { name: "常規任務", type: "am-phase-normal" };

            let match = currentWeekKey.match(/y(\d+)_w(\d+)/);
            if (!match) return { name: "常規任務", type: "am-phase-normal" };
            let y = parseInt(match[1]), w = parseInt(match[2]);
            let d = new Date(Date.UTC(y, 0, 1));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            let targetDate = new Date(d.getTime() + (w - 1) * 604800000).getTime();

            msList.sort((a, b) => new Date(a.start) - new Date(b.start));

            for (let m of msList) {
                let s = new Date(m.start).setHours(0, 0, 0, 0);
                let e = new Date(m.end).setHours(23, 59, 59, 999);
                if (targetDate >= s && targetDate <= e) return { name: m.phase, type: "am-phase-active" };
            }

            for (let m of msList) {
                if (targetDate < new Date(m.start).getTime()) return { name: `${m.phase} (預備)`, type: "am-phase-prep" };
            }
            return { name: `${msList[msList.length - 1].phase} (收尾)`, type: "am-phase-post" };
        }

        function updateAllocView() {
            const currentWeek = document.getElementById('allocWeekSelector').value;
            const weekText = document.getElementById('allocWeekSelector').options[document.getElementById('allocWeekSelector').selectedIndex].text;
            document.getElementById('allocRightPanelTitle').innerText = `👥 團隊負荷水位表 - ${weekText.split(' ')[1]}`;

            let currIdx = allocTimelineCols.findIndex(c => c.key === currentWeek);
            let startIdx = currIdx - 3;
            let endIdx = currIdx + 3;
            if (startIdx < 0) { endIdx += Math.abs(startIdx); startIdx = 0; }
            if (endIdx >= allocTimelineCols.length) { startIdx -= (endIdx - allocTimelineCols.length + 1); endIdx = allocTimelineCols.length - 1; }
            startIdx = Math.max(0, startIdx);
            let windowCols = allocTimelineCols.slice(startIdx, endIdx + 1);

            let projectGroups = {};
            let pendingCount = 0;
            let globalTaskDict = {};

            mainTableData.forEach(row => {
                let taskKey = `${row.region || ""}|${row.project || ""}|${row.category || ""}|${row.macro || ""}|${row.micro || ""}|${row.task || ""}|${row.subTask || ""}`;

                if (!globalTaskDict[taskKey]) {
                    globalTaskDict[taskKey] = { taskKey: taskKey, baseRow: row, weeklyData: {} };
                }

                allocTimelineCols.forEach(c => {
                    let val = parseFloat(row[c.key]);
                    if (val > 0) {
                        if (!globalTaskDict[taskKey].weeklyData[c.key]) {
                            globalTaskDict[taskKey].weeklyData[c.key] = { totalReq: 0, unassignedVal: 0, unassignedId: null, assignees: [] };
                        }
                        let wd = globalTaskDict[taskKey].weeklyData[c.key];
                        wd.totalReq += val;

                        if (!row.name || row.name === "") {
                            wd.unassignedVal += val;
                            wd.unassignedId = row._id || (Date.now() + Math.random());
                            row._id = wd.unassignedId;
                        } else {
                            // 💡 讀取並記錄 row.personalTask (各人事項)
                            wd.assignees.push({ _id: row._id || (Date.now() + Math.random()), name: row.name, val: val, personalTask: row.personalTask || "" });
                            row._id = wd.assignees[wd.assignees.length - 1]._id;
                        }
                    }
                });
            });

            for (let taskKey in globalTaskDict) {
                let task = globalTaskDict[taskKey];
                let row = task.baseRow;

                task.smartPhase = getSmartPhase(row.region, row.project, row.category, currentWeek);
                let hasAnyWeight = Object.keys(task.weeklyData).length > 0;

                if (hasAnyWeight || task.smartPhase.type === "am-phase-active" || task.smartPhase.type === "am-phase-prep") {
                    let groupKey = `${row.region}|${row.project}|${row.category}`;
                    if (!projectGroups[groupKey]) {
                        projectGroups[groupKey] = { region: row.region, project: row.project, category: row.category, tasks: [] };
                    }
                    projectGroups[groupKey].tasks.push(task);

                    let wdCurrent = task.weeklyData[currentWeek];
                    if (wdCurrent && wdCurrent.unassignedVal > 0) pendingCount++;
                }
            }

            let workloads = {};
            db.groupLinks.forEach(g => {
                if (!workloads[g.group]) workloads[g.group] = {};
                workloads[g.group][g.name] = { total: 0, tasks: [] };
            });

            mainTableData.forEach(row => {
                let val = parseFloat(row[currentWeek]);
                if (row.name && val > 0) {
                    let personGroup = db.groupLinks.find(g => g.name === row.name)?.group || "未分類";
                    if (!workloads[personGroup]) workloads[personGroup] = {};
                    if (!workloads[personGroup][row.name]) workloads[personGroup][row.name] = { total: 0, tasks: [] };

                    let phaseObj = getSmartPhase(row.region, row.project, row.category, currentWeek);
                    workloads[personGroup][row.name].total += val;
                    workloads[personGroup][row.name].tasks.push({ ...row, val, smartPhase: phaseObj });
                }
            });

            renderAllocEvents(projectGroups, pendingCount, currentWeek, windowCols);
            renderAllocPersonnel(workloads, currentWeek);
        }

        // 💡 接收上方計算好的 windowCols
        function renderAllocEvents(projectGroups, count, currentWeek, windowCols) {
            const listEl = document.getElementById('allocEventList');
            let countEl = document.getElementById('allocUnassignedCount');
            countEl.innerText = count;
            countEl.style.backgroundColor = count > 0 ? "var(--danger)" : "var(--success)";

            if (Object.keys(projectGroups).length === 0) {
                // 💡 移除「引入預備需求」的提示文字
                listEl.innerHTML = `<div class="empty-state">本週尚無任務規劃！</div>`;
                return;
            }

            let allPeople = db.groupLinks.map(g => g.name);
            let selectOptions = `<option value="">-- 指派 --</option>`;
            allPeople.forEach(p => selectOptions += `<option value="${p}">${p}</option>`);

            let thHtml = `<th class="am-task-info-td" style="text-align:left; padding-left:16px;">專案 / 任務資訊</th>`;
            windowCols.forEach(c => {
                let isCurrent = c.key === currentWeek ? "is-current" : "";
                thHtml += `<th class="${isCurrent}" style="min-width: 120px; width: 120px;">${c.label}<br><span style="font-size:10px; font-weight:normal; color:#64748b;">${c.dateStr}</span></th>`;
            });

            let html = `<table class="am-matrix"><thead><tr>${thHtml}</tr></thead><tbody>`;

            let windowStartMs = windowCols[0].startMs;
            let windowEndMs = windowCols[windowCols.length - 1].endMs;
            let windowDuration = windowEndMs - windowStartMs;

            for (let key in projectGroups) {
                let group = projectGroups[key];
                let msList = db.milestones.filter(m => m.region === group.region && m.project === group.project && m.category === group.category);
                msList.sort((a, b) => new Date(a.start) - new Date(b.start));

                let phasesHtml = "";
                if (msList.length > 0) {
                    phasesHtml = `<div style="position:relative; width:100%; height:24px; display:flex; align-items:center;">`;
                    msList.forEach(m => {
                        let mStart = new Date(m.start).setHours(0, 0, 0, 0);
                        let mEnd = new Date(m.end).setHours(23, 59, 59, 999);

                        if (mEnd >= windowStartMs && mStart <= windowEndMs) {
                            let renderStart = Math.max(mStart, windowStartMs);
                            let renderEnd = Math.min(mEnd, windowEndMs);

                            let leftPct = ((renderStart - windowStartMs) / windowDuration) * 100;
                            let widthPct = ((renderEnd - renderStart) / windowDuration) * 100;

                            let bgColor = m.category === 'NPI' ? '#e1f5fe' : '#e8f5e9';
                            let textColor = m.category === 'NPI' ? '#0288d1' : '#2e7d32';
                            let borderColor = m.category === 'NPI' ? '#81d4fa' : '#a5d6a7';

                            phasesHtml += `<div class="gantt-bar" style="position:absolute; left:${leftPct}%; width:${widthPct}%; background:${bgColor}; border:1px solid ${borderColor}; z-index:5; box-sizing:border-box; overflow:hidden;" title="[${m.category}] ${m.phase} (${m.start}~${m.end})">
								<span style="color:${textColor}">${formatDate(m.start)}</span>
								<b style="color:${textColor}">${m.phase}</b>
								<span style="color:${textColor}">${formatDate(m.end)}</span>
							</div>`;
                        }
                    });
                    phasesHtml += `</div>`;
                }

                html += `
				<tr class="am-group-row">
					<td class="am-task-info-td">
						<div style="display:flex; justify-content:space-between; align-items:center;">
							<span style="font-size:14px; font-weight:bold; color:#1e293b;">🌍 ${group.region} - 📦 ${group.project} <span style="color:#64748b; font-weight:normal;">(${group.category})</span></span>
						</div>
					</td>
					<td colspan="${windowCols.length}" style="padding: 0; vertical-align: middle; position: relative; border-right: none;">
						${phasesHtml}
					</td>
				</tr>`;

                for (let i = 0; i < group.tasks.length; i++) {
                    let t = group.tasks[i];
                    let safeTaskKey = t.taskKey.replace(/"/g, '&quot;');
                    let phaseClass = `am-badge-phase ${t.smartPhase.type}`;
                    let wdCurrent = t.weeklyData[currentWeek] || { totalReq: 0 };

                    html += `<tr>`;
                    html += `
					<td class="am-task-info-td">
						<div class="am-task-name"><span class="${phaseClass}">${t.smartPhase.name}</span><span>${t.baseRow.task}</span></div>
						<div class="am-task-path">${t.baseRow.macro} ➔ ${t.baseRow.micro} ${t.baseRow.subTask ? `(${t.baseRow.subTask})` : ''}</div>
						<div style="font-size:11px; color:#64748b; margin-top:4px;">
							當週需求: <input type="number" value="${wdCurrent.totalReq.toFixed(1)}" step="0.1" data-task="${safeTaskKey}" onchange="changeAllocTotalReq(this)" class="am-input-req" title="點擊修改"> 人
						</div>
					</td>`;

                    windowCols.forEach(c => {
                        let isCurrent = c.key === currentWeek ? "is-current" : "";
                        let currentStyle = c.key === currentWeek ? "border-left: 2px solid #60a5fa; border-right: 2px solid #60a5fa; box-shadow: inset 0 0 10px rgba(191,219,254,0.3);" : "";

                        let wd = t.weeklyData[c.key];
                        let tdHtml = "";

                        if (wd && wd.totalReq > 0) {
                            if (wd.assignees.length > 0) {
                                // 💡 顯示各人事項：如果該指派有填寫 personalTask，就在名字下方加上綠色小字
                                let parts = wd.assignees.map(a => `
									<div class="am-pill" style="display:block;">
										<div style="display:flex; justify-content:space-between; align-items:center;">
											<span>${a.name} <b style="opacity:0.7; font-weight:normal;">${a.val.toFixed(1)}</b></span>
											<button class="am-btn-rm" onclick="unassignAllocTask(${a._id}, '${c.key}')" title="拔除">✖</button>
										</div>
										${a.personalTask ? `<div style="font-size:10px; color:#065f46; opacity:0.8; margin-top:2px;">↳ ${a.personalTask}</div>` : ''}
									</div>
								`);
                                tdHtml += `<div style="margin-bottom:6px;">${parts.join('')}</div>`;
                            }

                            if (c.key === currentWeek) {
                                if (wd.unassignedVal > 0) {
                                    let defaultVal = Math.min(1.0, wd.unassignedVal).toFixed(1);

                                    // 💡 增加「各人事項」輸入框 (am_ptask_...)
                                    tdHtml += `
									<div class="am-assign-controls">
										<div style="font-size:11px; font-weight:bold; color:var(--danger); margin-bottom:4px; text-align:center;">尚缺 ${wd.unassignedVal.toFixed(1)}</div>
										<select id="am_sel_${wd.unassignedId}" class="am-assign-sel">${selectOptions}</select>
										<input type="text" id="am_ptask_${wd.unassignedId}" class="am-assign-sel" placeholder="各人事項 (選填)" style="margin-bottom:4px; background:#f8fafc; text-align:left;">
										<div style="display:flex; gap:4px;">
											<input type="number" id="am_val_${wd.unassignedId}" class="am-assign-val" value="${defaultVal}" min="0.1" max="${wd.unassignedVal}" step="0.1">
											<button class="am-btn-assign" onclick="assignAllocTask(${wd.unassignedId})">指派</button>
										</div>
									</div>`;
                                } else {
                                    tdHtml += `<div style="text-align:center; font-size:11px; color:var(--success); font-weight:bold; background:#d1fae5; border-radius:4px; padding:4px 0; border: 1px solid #a7f3d0;">✅ 滿編</div>`;
                                }
                            } else {
                                if (wd.unassignedVal > 0) tdHtml += `<div class="am-missing">缺 ${wd.unassignedVal.toFixed(1)}</div>`;
                            }
                        } else {
                            tdHtml = `<div style="text-align:center; color:#cbd5e1; font-size:11px; margin-top:8px;">-</div>`;
                        }
                        html += `<td class="${isCurrent}" style="${currentStyle}">${tdHtml}</td>`;
                    });
                    html += `</tr>`;
                }
            }
            html += `</tbody></table>`;
            listEl.innerHTML = html;
        }

        function renderAllocPersonnel(workloads, currentWeek) {
            const listEl = document.getElementById('allocPersonnelList');
            let html = "";

            let sortedGroups = Object.keys(workloads).sort();

            for (let group of sortedGroups) {
                let sortedPeople = Object.keys(workloads[group]).sort((a, b) => workloads[group][b].total - workloads[group][a].total);

                html += `
				<div class="am-group-hdr" onclick="let c = this.nextElementSibling; let i = this.querySelector('.am-grp-icon'); if(c.style.display==='none'){c.style.display='block'; i.innerText='▼';}else{c.style.display='none'; i.innerText='▶';}" onmouseover="this.style.backgroundColor='#f1f5f9'" onmouseout="this.style.backgroundColor='transparent'" style="cursor:pointer; font-size:13px; color:#475569; border-bottom:2px solid #cbd5e1; padding:6px 4px; margin:15px 0 5px 0; display:flex; align-items:center; justify-content:space-between; transition:0.2s; border-radius:4px 4px 0 0;">
					<div style="display:flex; align-items:center; gap:8px;">
						<span style="background:#e2e8f0; padding:2px 6px; border-radius:4px; font-weight:bold; color:#1e293b;">🏢 ${group}</span>
						<span style="font-size:11px; color:#64748b; font-weight:normal;">(共 ${sortedPeople.length} 人)</span>
					</div>
					<span class="am-grp-icon" style="font-size:10px; color:#94a3b8; font-weight:bold; padding-right:4px;">▼</span>
				</div>`;

                html += `<div class="am-group-content" style="display:block;">`;

                for (let name of sortedPeople) {
                    let data = workloads[group][name];
                    let total = data.total;

                    let barColor = "#10b981"; let textColor = "#047857"; let bgColor = "#f0fdf4"; let borderColor = "#bbf7d0";
                    if (total === 0) {
                        barColor = "#cbd5e1"; textColor = "#94a3b8"; bgColor = "#f8fafc"; borderColor = "#e2e8f0";
                    } else if (total < 0.8) {
                        barColor = "#f59e0b"; textColor = "#b45309"; bgColor = "#fffbeb"; borderColor = "#fde68a";
                    } else if (total > 1.0) {
                        barColor = "#ef4444"; textColor = "#b91c1c"; bgColor = "#fef2f2"; borderColor = "#fecaca";
                    }

                    let widthPct = Math.min(total * 100, 100);

                    let badgesHtml = data.tasks.sort((a, b) => b.val - a.val).map(t => {
                        let phaseColor = t.smartPhase.type === 'am-phase-active' ? '#3b82f6' : (t.smartPhase.type === 'am-phase-prep' ? '#eab308' : '#94a3b8');

                        // 💡 如果有各人事項，就在卡片中串接顯示
                        let pTaskHtml = t.personalTask ? `<span style="color:#0f172a; font-weight:bold;"> ➔ ${t.personalTask}</span>` : '';

                        return `
						<div class="am-task-tag" title="[${t.smartPhase.name}] ${t.project} - ${t.task}${t.personalTask ? ` ➔ ${t.personalTask}` : ''}" style="display:flex; align-items:center; background:#fff; border:1px solid #e2e8f0; padding:6px 8px 6px 12px; border-radius:6px; position:relative; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,0.02); flex: 1 1 calc(50% - 6px); min-width:140px; cursor:default;">
							<div style="position:absolute; left:0; top:0; bottom:0; width:4px; background-color:${phaseColor};"></div>
							<div style="display:flex; flex-direction:column; gap:4px; width:100%;">
								<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:4px;">
									<span style="font-weight:700; font-size:12px; color:#1e293b; line-height:1.2; text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">📦 ${t.project}</span>
									<span style="font-weight:900; color:#0f172a; font-size:13px; background:#f1f5f9; padding:0 4px; border-radius:4px; border:1px solid #e2e8f0;">${t.val.toFixed(1)}</span>
								</div>
								<div style="font-size:10px; color:#64748b; display:flex; justify-content:space-between; align-items:center;">
									<span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:85%;"><span>${t.task}</span>${pTaskHtml} <span style="opacity:0.6; margin-left:4px;">(${t.smartPhase.name})</span></span>
									<button class="am-tag-rm" onclick="unassignAllocTask(${t._id}, '${currentWeek}')" title="拔除任務" style="cursor:pointer; padding:0 2px;">✖</button>
								</div>
							</div>
						</div>`;
                    }).join('');

                    if (!badgesHtml) badgesHtml = `<div style="font-size:11px; color:#94a3b8; font-style:italic; padding:6px; width:100%; text-align:center;">🏖️ 本週無指派任務</div>`;

                    html += `
					<div class="am-person" style="border: 1px solid ${borderColor}; background-color: ${bgColor}; margin-bottom: 8px; border-radius:8px; padding:12px; transition:0.2s;">
						<div class="am-person-row" style="margin-bottom: 12px; display:flex; align-items:center; gap:12px;">
							<div class="am-person-name" style="width: 70px; text-align: right; font-weight:bold; color:#334155; font-size:14px;">${name}</div>
							<div class="am-track" style="flex:1; height:8px; background:#e2e8f0; border-radius:4px; position:relative;">
								<div class="am-fill" style="height:100%; border-radius:4px; transition:width 0.4s, background-color 0.4s; width: ${widthPct}%; background-color: ${barColor};"></div>
								<div style="position:absolute; left:100%; top:-3px; bottom:-3px; width:2px; background:#475569; z-index:2; opacity:0.6;" title="滿編 1.0 基準線"></div>
							</div>
							<div class="am-val" style="color: ${textColor}; width: 35px; text-align:right; font-weight:800; font-size:13px;">${total.toFixed(1)}</div>
						</div>
						<div class="am-tasks" style="padding-left: 0; display: flex; flex-wrap: wrap; gap: 6px;">
							${badgesHtml}
						</div>
					</div>`;
                }

                html += `</div>`;
            }

            if (html === "") {
                html = `<div style="text-align:center; padding:30px 20px; color:#94a3b8; font-size:14px;">本週尚無任何團隊任務資料。</div>`;
            }

            listEl.innerHTML = html;
        }

        window.openAllocAddReqModal = function () {
            const projSelect = document.getElementById('allocNewReqProject');
            projSelect.innerHTML = db.rpLinks.map(l => {
                let ms = db.milestones.find(m => m.region === l.region && m.project === l.project);
                let cat = ms ? ms.category : 'NPI';
                return `<option value="${l.region}|${l.project}|${cat}">🌍 ${l.region} - 📦 ${l.project} (${cat})</option>`;
            }).join('');
            document.getElementById('allocAddReqModal').style.display = 'block';
        }

        window.submitAllocNewReq = function () {
            const currentWeek = document.getElementById('allocWeekSelector').value;
            const projVal = document.getElementById('allocNewReqProject').value;
            const [region, project, category] = projVal.split('|');
            const macro = document.getElementById('allocNewReqMacro').value;
            const micro = document.getElementById('allocNewReqMicro').value;
            const task = document.getElementById('allocNewReqTask').value;
            const val = document.getElementById('allocNewReqVal').value;

            if (!task) return alert('請填寫任務名稱！');
            if (parseFloat(val) <= 0) return alert('需求人力須大於 0');

            let newRow = { _id: Date.now() + Math.floor(Math.random() * 100000), region, project, category, macro, micro, task, subTask: "", group: "", name: "" };
            allocTimelineCols.forEach(c => newRow[c.key] = "");
            newRow[currentWeek] = parseFloat(val).toFixed(1);
            mainTableData.push(newRow);

            saveAllStorage(); renderMainTable();
            document.getElementById('allocAddReqModal').style.display = 'none';
            updateAllocView();
        }

        window.changeAllocTotalReq = function (inputEl) {
            const currentWeek = document.getElementById('allocWeekSelector').value;
            const taskKey = inputEl.getAttribute('data-task');
            const [region, project, category, macro, micro, task, subTask] = taskKey.split('|');
            const newVal = parseFloat(inputEl.value);

            if (isNaN(newVal) || newVal < 0) { alert("請輸入有效的數字！"); updateAllocView(); return; }

            let taskRows = mainTableData.filter(r => (r.region || "") === region && (r.project || "") === project && (r.category || "") === category && (r.macro || "") === macro && (r.micro || "") === micro && (r.task || "") === task && (r.subTask || "") === subTask);
            let assignedTotal = 0; let unassignedRowIndex = -1;

            taskRows.forEach(r => {
                let val = parseFloat(r[currentWeek]) || 0;
                if (r.name && r.name !== "") assignedTotal += val;
                else if (val > 0) unassignedRowIndex = mainTableData.findIndex(mainR => mainR === r);
            });

            if (newVal < assignedTotal) { alert(`無法降低！已指派 ${assignedTotal.toFixed(1)}。請先從下方週期表拔除人員。`); updateAllocView(); return; }

            let newUnassignedVal = newVal - assignedTotal;

            if (unassignedRowIndex > -1) {
                if (newUnassignedVal > 0) mainTableData[unassignedRowIndex][currentWeek] = newUnassignedVal.toFixed(1);
                else mainTableData[unassignedRowIndex][currentWeek] = "";
            } else {
                if (newUnassignedVal > 0 && taskRows.length > 0) {
                    let newRow = { _id: Date.now() + Math.floor(Math.random() * 100000), region, project, category, macro, micro, task, subTask, group: "", name: "" };
                    allocTimelineCols.forEach(c => newRow[c.key] = "");
                    newRow[currentWeek] = newUnassignedVal.toFixed(1);
                    mainTableData.push(newRow);
                }
            }
            saveAllStorage(); renderMainTable(); updateAllocView();
        }

        window.assignAllocTask = function (unassignedId) {
            const currentWeek = document.getElementById('allocWeekSelector').value;
            const personName = document.getElementById(`am_sel_${unassignedId}`).value;
            const assignVal = parseFloat(document.getElementById(`am_val_${unassignedId}`).value);

            // 💡 獲取各人事項輸入值
            const pTask = document.getElementById(`am_ptask_${unassignedId}`).value.trim();

            if (!personName) return alert("請先選擇人員！");
            if (isNaN(assignVal) || assignVal <= 0) return alert("分配額度必須大於 0！");

            let targetIdx = mainTableData.findIndex(r => r._id == unassignedId);
            if (targetIdx === -1) return alert("找不到任務");

            let targetRow = mainTableData[targetIdx];
            let originalVal = parseFloat(targetRow[currentWeek]);

            let newRow = JSON.parse(JSON.stringify(targetRow));
            newRow._id = Date.now() + Math.floor(Math.random() * 100000);
            newRow.name = personName;
            newRow.group = db.groupLinks.find(g => g.name === personName)?.group || "未分類";

            // 💡 寫入各人事項到新資料行中
            newRow.personalTask = pTask;

            allocTimelineCols.forEach(c => newRow[c.key] = "");
            newRow[currentWeek] = assignVal.toFixed(1);
            mainTableData.push(newRow);

            if (assignVal < originalVal) targetRow[currentWeek] = (originalVal - assignVal).toFixed(1);
            else targetRow[currentWeek] = "";

            saveAllStorage(); renderMainTable(); updateAllocView();
        }

        window.unassignAllocTask = function (taskId, targetWeekKey) {
            let targetIdx = mainTableData.findIndex(r => r._id == taskId);

            if (targetIdx > -1) {
                let targetRow = mainTableData[targetIdx];
                let valToReturn = parseFloat(targetRow[targetWeekKey]);
                if (isNaN(valToReturn) || valToReturn <= 0) return;

                let existingUnassigned = mainTableData.find(r =>
                    r._id != taskId && (!r.name || r.name === "") &&
                    r.region === targetRow.region && r.project === targetRow.project && r.category === targetRow.category &&
                    r.macro === targetRow.macro && r.micro === targetRow.micro && r.task === targetRow.task && r.subTask === targetRow.subTask
                );

                if (existingUnassigned) {
                    existingUnassigned[targetWeekKey] = (parseFloat(existingUnassigned[targetWeekKey] || 0) + valToReturn).toFixed(1);
                } else {
                    let newRow = JSON.parse(JSON.stringify(targetRow));
                    newRow._id = Date.now() + Math.floor(Math.random() * 100000);
                    newRow.name = ""; newRow.group = "";
                    allocTimelineCols.forEach(c => newRow[c.key] = "");
                    newRow[targetWeekKey] = valToReturn.toFixed(1);
                    mainTableData.push(newRow);
                }

                targetRow[targetWeekKey] = "";
                saveAllStorage(); renderMainTable(); updateAllocView();
            }
        }
        // ================= 切換進階排程區塊 =================
        window.toggleAdvancedScheduling = function (forceState) {
            const block = document.getElementById('advanced_scheduling_block');
            const btn = document.getElementById('btn_toggle_advanced');

            if (forceState === 'open' || (forceState !== 'close' && block.style.display === 'none')) {
                block.style.display = 'block';
                btn.innerHTML = '🔼 收合進階排程';
                btn.style.backgroundColor = '#e2e8f0';
            } else {
                block.style.display = 'none';
                btn.innerHTML = '🔽 展開進階排程 (長期批次指派人員與週權重)';
                btn.style.backgroundColor = '#f8fafc';
            }
        }
    </script>
</body>

</html>