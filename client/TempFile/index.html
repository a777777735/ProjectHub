<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯éš¨èº«ç­†è¨˜</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        input[type="text"], input[type="password"], textarea, button { width: 100%; margin-bottom: 12px; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 300px; resize: vertical; font-family: inherit; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        button.btn-danger { background-color: #dc3545; }
        button.btn-danger:hover { background-color: #a71d2a; }
        #editor-section { display: none; }
        .msg-box { text-align: center; font-weight: bold; min-height: 24px; margin-bottom: 10px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #856404; font-size: 14px; text-align: center; margin-bottom: 15px; }
        
        .file-section { background-color: #f1f8ff; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px dashed #007bff; }
        .file-list { margin-top: 10px; font-size: 14px; }
        .file-item { margin-bottom: 5px; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .file-item a { color: #007bff; text-decoration: none; word-break: break-all;}
        .file-item a:hover { text-decoration: underline; }
        input[type="file"] { margin-bottom: 5px; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“ é›²ç«¯éš¨èº«ç­†è¨˜</h2>
        <div class="warning">âš ï¸ æ³¨æ„ï¼šä¼ºæœå™¨ä¼‘çœ æˆ–é‡å•Ÿæ™‚ï¼Œæ‰€æœ‰æ–‡ç« èˆ‡æª”æ¡ˆå°‡æœƒæ¸…ç©ºã€‚</div>

        <div id="auth-section">
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥è‡ªè¨‚å¸³è™Ÿ (ç„¡å¸³è™Ÿå°‡è‡ªå‹•è¨»å†Š)" />
            <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
            <button onclick="handleAction('read')">ç™»å…¥ä¸¦è®€å–è³‡æ–™</button>
            <div id="auth-msg" class="msg-box error"></div>
        </div>

        <div id="editor-section">
            <p style="text-align: right; margin: 0 0 10px 0;">ç›®å‰ç™»å…¥ï¼š<strong id="display-user"></strong></p>
            <textarea id="content" placeholder="åœ¨é€™è£¡è²¼ä¸Šæˆ–è¼¸å…¥ç„¡é™é•·åº¦çš„æ–‡å­—..."></textarea>
            
            <div class="file-section">
                <strong>ğŸ“ é™„åŠ æª”æ¡ˆ (ä¸é™æ ¼å¼)</strong>
                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">æª”æ¡ˆæœƒéš¨æ–‡ç« ä¸€èµ·å„²å­˜ã€‚å»ºè­°å–®æ¬¡ä¸Šå‚³ç¸½å¤§å°ä¸è¦è¶…é 10MBã€‚</div>
                <input type="file" id="file-upload" multiple />
                
                <div id="server-files-container" style="display: none; margin-top: 15px;">
                    <strong>é›²ç«¯ç¾æœ‰æª”æ¡ˆ (é»æ“Šä¸‹è¼‰)ï¼š</strong>
                    <div id="file-list" class="file-list"></div>
                </div>
            </div>

            <button onclick="handleAction('write')">ğŸ’¾ å„²å­˜æ–‡å­—èˆ‡æª”æ¡ˆåˆ°é›²ç«¯</button>
            <button class="btn-danger" onclick="logout()">ğŸšª ç™»å‡º</button>
            <div id="editor-msg" class="msg-box success"></div>
        </div>
    </div>

    <script>
        let currentUsername = '';
        let currentPassword = '';

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function handleAction(action) {
            const userEl = document.getElementById('username');
            const passEl = document.getElementById('password');
            const contentEl = document.getElementById('content');
            const fileInput = document.getElementById('file-upload');
            const authMsg = document.getElementById('auth-msg');
            const editorMsg = document.getElementById('editor-msg');

            const u = currentUsername || userEl.value.trim();
            const p = currentPassword || passEl.value.trim();
            const c = contentEl.value;

            if (!u || !p) {
                authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼";
                return;
            }

            authMsg.textContent = "è™•ç†ä¸­...";
            editorMsg.textContent = "è³‡æ–™å‚³è¼¸ä¸­...";

            let filesData = [];
            if (action === 'write' && fileInput.files.length > 0) {
                for (const file of fileInput.files) {
                    try {
                        const base64Data = await getBase64(file);
                        filesData.push({ name: file.name, type: file.type, data: base64Data });
                    } catch (err) {
                        console.error("æª”æ¡ˆè®€å–å¤±æ•—", err);
                    }
                }
            }

            try {
                const payload = { username: u, password: p, action: action, content: c };
                if (action === 'write' && filesData.length > 0) {
                    payload.files = filesData;
                }

                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    authMsg.textContent = data.error || "ç™¼ç”ŸéŒ¯èª¤";
                    editorMsg.textContent = data.error || "ç™¼ç”ŸéŒ¯èª¤";
                    editorMsg.className = "msg-box error";
                    return;
                }

                if (action === 'read') {
                    currentUsername = u;
                    currentPassword = p;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('editor-section').style.display = 'block';
                    document.getElementById('display-user').textContent = currentUsername;
                    contentEl.value = data.content || "";
                    
                    renderFiles(data.files);

                    editorMsg.textContent = data.message;
                    editorMsg.className = "msg-box success";
                } else if (action === 'write') {
                    editorMsg.textContent = data.message;
                    editorMsg.className = "msg-box success";
                    fileInput.value = ""; 
                    
                    if(filesData.length > 0) {
                        handleAction('read');
                    } else {
                        setTimeout(() => editorMsg.textContent = "", 3000);
                    }
                }

            } catch (err) {
                authMsg.textContent = "é€£ç·šéŒ¯èª¤";
                editorMsg.textContent = "é€£ç·šéŒ¯èª¤";
                editorMsg.className = "msg-box error";
            }
        }

        function renderFiles(files) {
            const container = document.getElementById('server-files-container');
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            if (files && files.length > 0) {
                container.style.display = 'block';
                files.forEach(f => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item';
                    
                    const link = document.createElement('a');
                    link.href = f.data;
                    link.download = f.name;
                    link.textContent = 'ğŸ“ ' + f.name;
                    
                    itemDiv.appendChild(link);
                    fileList.appendChild(itemDiv);
                });
            } else {
                container.style.display = 'none';
            }
        }

        function logout() {
            currentUsername = '';
            currentPassword = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('content').value = '';
            document.getElementById('file-upload').value = '';
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('server-files-container').style.display = 'none';
            document.getElementById('editor-msg').textContent = '';
            document.getElementById('auth-msg').textContent = '';
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('editor-section').style.display = 'none';
        }
    </script>
</body>
</html>